# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status

**Ready for Review**

---

## Story

**As a** 로그인한 사용자,  
**I want** 노트 작성 시 내용을 자동으로 요약,  
**so that** 긴 노트의 핵심 내용을 빠르게 파악할 수 있습니다.

---

## Acceptance Criteria

1. 노트를 생성하거나 수정할 때 "AI 요약 생성" 버튼이 표시되어야 한다
2. "AI 요약 생성" 버튼 클릭 시 Gemini API를 호출하여 노트 내용을 요약해야 한다
3. 생성된 요약은 3-6개의 불릿 포인트 형식이어야 한다
4. 요약은 데이터베이스의 `summaries` 테이블에 저장되어야 한다
5. 노트당 하나의 요약만 저장되어야 한다 (기존 요약이 있으면 업데이트)
6. 요약 생성 중 로딩 상태를 표시해야 한다
7. 요약 생성 완료 시 사용자에게 성공 메시지를 표시해야 한다
8. 요약 생성 실패 시 사용자 친화적인 에러 메시지를 표시해야 한다
9. 노트 상세 페이지에서 생성된 요약을 확인할 수 있어야 한다
10. 요약은 노트 작성자만 생성하고 조회할 수 있어야 한다 (사용자 스코프)
11. 노트 내용이 너무 짧은 경우 (예: 50자 미만) 적절한 안내 메시지를 표시해야 한다
12. 요약 생성 시 사용된 AI 모델 정보를 함께 저장해야 한다

---

## Tasks / Subtasks

- [x] Task 1: AI 요약 생성 Server Action 구현 (AC: 2, 3, 4, 5, 10, 12)
  - [x] `app/actions/summaries.ts` 생성
  - [x] `generateSummary(noteId: string)` 함수 구현:
    - [x] 사용자 인증 확인 (Supabase Auth)
    - [x] noteId로 노트 조회 및 권한 검증 (사용자 스코프)
    - [x] 노트 내용 유효성 검사 (최소 길이 50자)
    - [x] 요약 생성 프롬프트 구성 (3-6 불릿 포인트 요구)
    - [x] Gemini API 호출 (`generateText` 함수 사용)
    - [x] 기존 요약 확인 (summaries 테이블 조회)
    - [x] 기존 요약 있으면 UPDATE, 없으면 INSERT
    - [x] 모델 정보 (`gemini-2.0-flash-001`) 저장
    - [x] 성공/실패 응답 반환

- [x] Task 2: 노트 상세 페이지에 요약 표시 섹션 추가 (AC: 9)
  - [x] `app/notes/[id]/page.tsx` 수정
  - [x] 노트 조회 시 요약 데이터 함께 가져오기 (Drizzle relations 활용)
  - [x] 요약 표시 UI 영역 추가
  - [x] 요약이 없는 경우 "요약 없음" 상태 표시

- [x] Task 3: 요약 생성 버튼 UI 컴포넌트 (AC: 1, 6, 7, 8, 11)
  - [x] `components/notes/SummaryGenerateButton.tsx` 생성
  - [x] Props: `noteId`, `hasExistingSummary`, `onSuccess`
  - [x] "AI 요약 생성" 버튼
  - [x] 버튼 클릭 시 `generateSummary` Server Action 호출
  - [x] 로딩 상태 표시 (스피너 + "요약 생성 중...")
  - [x] 성공 시 Toast 알림 ("요약이 생성되었습니다")
  - [x] 실패 시 Toast 알림 (에러 메시지)
  - [x] 노트 내용이 짧은 경우 안내 메시지

- [x] Task 4: 요약 표시 UI 컴포넌트 (AC: 9)
  - [x] `components/notes/SummaryDisplay.tsx` 생성
  - [x] Props: `summary` (content, model, createdAt)
  - [x] 요약 내용 표시 (마크다운 불릿 포인트 렌더링)
  - [x] 생성 시간 표시 ("5분 전", "1시간 전" 등)
  - [x] 사용된 AI 모델 정보 표시 (선택 사항)
  - [x] 읽기 좋은 스타일링 (배경색, 패딩 등)

- [x] Task 5: 요약 생성 프롬프트 최적화 (AC: 3)
  - [x] `lib/gemini/prompts.ts` 생성
  - [x] `createSummaryPrompt(noteContent: string)` 함수:
    - [x] 명확한 요약 지시사항 포함
    - [x] 3-6개 불릿 포인트 요구
    - [x] 한국어 요약 명시
    - [x] 핵심 내용 추출 강조
  - [x] 프롬프트 템플릿 작성

- [x] Task 6: Drizzle 쿼리 헬퍼 함수 (AC: 4, 5, 10)
  - [x] Server Action에 직접 구현 (별도 파일 불필요)

- [x] Task 7: 단위 테스트 작성
  - [x] `__tests__/unit/actions/summaries.test.ts`:
    - [x] 정상적인 요약 생성 테스트
    - [x] 노트 내용이 짧은 경우 테스트
    - [x] 권한 없는 사용자 접근 테스트
    - [x] 기존 요약 업데이트 테스트
  - [x] `__tests__/unit/notes/SummaryGenerateButton.test.tsx`:
    - [x] 버튼 렌더링 테스트
    - [x] 클릭 시 Server Action 호출 테스트
    - [x] 로딩 상태 표시 테스트
  - [x] `__tests__/unit/notes/SummaryDisplay.test.tsx`:
    - [x] 요약 표시 테스트
    - [x] 시간 포맷팅 테스트
  - [x] `__tests__/unit/gemini/prompts.test.ts`:
    - [x] 프롬프트 생성 테스트
    - [x] 노트 내용 자르기 테스트

- [x] Task 8: 통합 테스트 작성 (선택 사항)
  - [x] 스킵 (단위 테스트로 충분)

---

## Dev Notes

### 기술 스택 및 아키텍처 개요
[Source: docs/architecture.md#1-기술-스택]
- **프레임워크:** Next.js (App Router, Server Actions)
- **AI 모델:** Google Gemini API (gemini-2.0-flash-001)
- **ORM:** Drizzle ORM
- **DB:** Supabase Postgres

### Epic 4 목표
[Source: docs/epics/epic-4-ai-summary-tagging.md]
- 3-6개 불릿 포인트로 구성된 정확한 요약 제공
- AI 처리 시간 10초 이내
- 요약 정확도 90% 이상 (사용자 만족도 기준)

### 이전 스토리 완료 사항

**Story 4.1: Gemini API 설정 및 연동**
[Source: docs/stories/4.1.story.md]
- ✅ Gemini SDK (`@google/genai`) 설치 완료
- ✅ `lib/gemini/client.ts`: Gemini 클라이언트 초기화 (싱글톤)
- ✅ `lib/gemini/generateText.ts`: 텍스트 생성 함수
- ✅ `lib/utils/aiErrorHandler.ts`: AI 에러 핸들러
- ✅ `lib/types/ai.ts`: AI 에러 타입 정의
- ✅ 기본 모델: `gemini-2.0-flash-001`
- ✅ 타임아웃: 10초
- ✅ 토큰 제한: maxOutputTokens 8192

### 데이터베이스 스키마

**summaries 테이블**
[Source: drizzle/schema.ts]
```typescript
export const summaries = pgTable('summaries', {
  id: uuid('id').defaultRandom().primaryKey(),
  noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }).unique(),
  model: varchar('model', { length: 100 }).notNull(), // "gemini-2.0-flash-001"
  content: text('content').notNull(), // 요약 내용 (3-6 불릿 포인트)
  createdAt: timestamp('created_at').notNull().defaultNow(),
})
```

**주요 특징:**
- `noteId`에 UNIQUE 제약조건: 노트당 하나의 요약만 허용
- `onDelete: 'cascade'`: 노트 삭제 시 요약도 자동 삭제
- `model` 필드: 사용된 AI 모델 정보 저장

**노트 관계:**
```typescript
export const notesRelations = relations(notes, ({ one }) => ({
  summary: one(summaries, {
    fields: [notes.id],
    references: [summaries.noteId],
  }),
}))
```

### Server Action 패턴

**기존 노트 관련 Server Actions**
[Source: app/actions/notes.ts]
```typescript
// 표준 패턴:
export async function actionName(params): Promise<{
  success: boolean
  data?: ReturnType
  error?: string
}> {
  try {
    // 1. 사용자 인증 확인
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    
    if (authError || !user) {
      return { success: false, error: '로그인이 필요합니다.' }
    }
    
    // 2. 입력값 유효성 검사
    // 3. 권한 검증 (사용자 스코프)
    // 4. 비즈니스 로직 실행
    // 5. DB 작업
    // 6. 성공 응답 반환
    
    return { success: true, data: result }
  } catch (error) {
    console.error('Error:', error)
    return { success: false, error: '처리 실패' }
  }
}
```

### AI 요약 생성 프롬프트 설계

**요구사항:**
- 3-6개의 불릿 포인트
- 한국어로 작성
- 핵심 내용 추출
- 간결하고 명확한 표현

**프롬프트 예시:**
```typescript
export function createSummaryPrompt(noteContent: string): string {
  return `다음 노트 내용을 3-6개의 불릿 포인트로 요약해주세요.

요약 규칙:
- 반드시 3개 이상, 6개 이하의 불릿 포인트로 작성
- 각 불릿 포인트는 한 문장으로 간결하게
- 핵심 내용과 중요한 정보 중심으로 추출
- 불릿 포인트 형식: "- 내용"
- 한국어로 작성

노트 내용:
${noteContent}

요약:`
}
```

### Gemini API 호출 방법

**기존 유틸리티 활용:**
[Source: lib/gemini/generateText.ts]
```typescript
import { generateText } from '@/lib/gemini/generateText'

const result = await generateText(prompt)

if (result.success && result.text) {
  // 요약 텍스트 사용
  const summary = result.text
} else {
  // 에러 처리
  const errorMessage = result.error
}
```

### Drizzle ORM 쿼리 패턴

**요약 조회:**
```typescript
import { db } from '@/lib/db'
import { summaries } from '@/drizzle/schema'
import { eq } from 'drizzle-orm'

// 기존 요약 확인
const [existingSummary] = await db
  .select()
  .from(summaries)
  .where(eq(summaries.noteId, noteId))
  .limit(1)
```

**요약 생성 (INSERT):**
```typescript
const [newSummary] = await db
  .insert(summaries)
  .values({
    noteId,
    model: 'gemini-2.0-flash-001',
    content: summaryText,
  })
  .returning()
```

**요약 업데이트 (UPDATE):**
```typescript
const [updatedSummary] = await db
  .update(summaries)
  .set({
    content: summaryText,
    model: 'gemini-2.0-flash-001',
  })
  .where(eq(summaries.noteId, noteId))
  .returning()
```

**노트와 요약 함께 조회 (Relations):**
```typescript
import { notes, summaries } from '@/drizzle/schema'

const noteWithSummary = await db.query.notes.findFirst({
  where: eq(notes.id, noteId),
  with: {
    summary: true, // 관계 정의된 요약 포함
  },
})
```

### 권한 스코프 검증

**노트 소유자 확인 패턴:**
[Source: app/actions/notes.ts]
```typescript
// 노트 조회 시 사용자 스코프 강제
const [note] = await db
  .select()
  .from(notes)
  .where(and(
    eq(notes.id, noteId),
    eq(notes.userId, user.id) // 소유자만 접근 가능
  ))
  .limit(1)

if (!note) {
  return { success: false, error: '노트를 찾을 수 없습니다.' }
}
```

### 파일 구조

```
app/
  actions/
    summaries.ts            # (신규) 요약 생성 Server Action
  notes/
    [id]/
      page.tsx              # (수정) 요약 표시 추가
lib/
  gemini/
    prompts.ts              # (신규) AI 프롬프트 템플릿
  db/
    summaries.ts            # (신규, 선택) 요약 쿼리 헬퍼
components/
  notes/
    SummaryGenerateButton.tsx  # (신규) 요약 생성 버튼
    SummaryDisplay.tsx         # (신규) 요약 표시
__tests__/
  unit/
    actions/
      summaries.test.ts     # (신규) Server Action 테스트
    notes/
      SummaryGenerateButton.test.tsx  # (신규)
      SummaryDisplay.test.tsx         # (신규)
  integration/
    summaries/
      generate-summary.test.ts  # (신규, 선택)
```

### UI/UX 고려사항

**요약 생성 버튼 위치:**
- 노트 상세 페이지: 제목/본문 하단
- 노트 수정 페이지: 저장 버튼 근처

**로딩 상태:**
- 버튼 비활성화
- 스피너 아이콘 표시
- "요약 생성 중..." 텍스트

**에러 처리:**
- 노트 내용이 짧은 경우: "노트 내용이 너무 짧습니다. 최소 50자 이상 작성해주세요."
- AI 처리 실패: "요약 생성에 실패했습니다. 다시 시도해주세요."
- 타임아웃: "AI 처리 시간이 초과되었습니다. 다시 시도해주세요."

**요약 표시 스타일:**
- 배경색: 연한 파란색 또는 회색
- 패딩: 적절한 여백
- 불릿 포인트: 목록 형식으로 명확하게
- 타이틀: "📝 AI 요약" 또는 "✨ 요약"

### 보안 고려사항
[Source: docs/architecture.md#3-보안]
- Gemini API 호출은 서버에서만 (Server Action)
- 요약 조회 시 노트 소유자 검증 필수
- 사용자 스코프: notes.userId = user.id
- API 키는 환경 변수로 관리 (클라이언트 노출 금지)

### 성능 최적화

**토큰 제한:**
- 노트 내용이 매우 긴 경우 (예: 10,000자 이상) 잘라내기 고려
- maxOutputTokens: 8192 (Story 4.1에서 설정됨)

**캐싱:**
- 노트 내용이 변경되지 않았으면 재생성 불필요
- 기존 요약 재사용

**비동기 처리:**
- 요약 생성은 비동기로 처리
- 사용자는 로딩 상태 확인 가능

### Testing

**테스트 프레임워크:**
[Source: Epic 2 - 기술적 요구사항]
- **Framework:** Jest + React Testing Library
- **실행:** `pnpm test`
- **위치:** `__tests__/unit/`, `__tests__/integration/`

**단위 테스트 요구사항:**
- Server Action 모킹 (Supabase, Drizzle, Gemini API)
- 컴포넌트 렌더링 및 인터랙션 테스트
- 에러 시나리오 검증

**통합 테스트 (선택):**
- End-to-end 플로우 검증
- 실제 DB 작업 확인 (테스트 DB 사용)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | Bob (SM Agent) |
| 2025-10-14 | 2.0 | 스토리 구현 완료 (모든 Task 완료, 29개 테스트 통과) | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- 테스트 실패 (summaries.test.ts): 노트 내용이 50자 미만으로 유효성 검사 실패 → 테스트 데이터 수정
- Jest ES 모듈 에러 (@google/genai): `jest.mock`으로 `lib/gemini/client.ts` 모킹하여 해결

### Completion Notes List

1. **AI 요약 생성 Server Action 구현 완료**
   - `generateSummary`: 노트 내용 기반 요약 생성 (INSERT/UPDATE)
   - `getSummary`: 노트의 요약 조회
   - 최소 길이 검증 (50자), 사용자 스코프 검증, 에러 핸들링

2. **프롬프트 최적화**
   - `createSummaryPrompt`: 3-6개 불릿 포인트 생성 프롬프트
   - `truncateNoteContent`: 긴 노트 내용 자르기 (8000자 제한)

3. **UI 컴포넌트 구현 완료**
   - `SummaryDisplay`: 요약 내용 표시 (불릿 포인트, 시간, 모델 정보)
   - `SummaryGenerateButton`: 요약 생성/재생성 버튼 (로딩, Toast 알림)
   - `SummarySection`: 요약 섹션 컨테이너 (빈 상태 처리)

4. **노트 상세 페이지 수정**
   - `getNoteById`: Drizzle relations로 요약 데이터 함께 조회
   - `app/notes/[id]/page.tsx`: 요약 섹션 추가

5. **단위 테스트 완료 (29개 테스트 통과)**
   - Server Actions, UI 컴포넌트, 프롬프트 유틸리티 검증
   - 모든 AC 충족 확인

### File List

**생성된 파일:**
- `lib/gemini/prompts.ts`: 요약 프롬프트 템플릿
- `app/actions/summaries.ts`: 요약 생성/조회 Server Actions
- `components/notes/SummaryDisplay.tsx`: 요약 표시 UI
- `components/notes/SummaryGenerateButton.tsx`: 요약 생성 버튼 UI
- `components/notes/SummarySection.tsx`: 요약 섹션 컨테이너
- `__tests__/unit/actions/summaries.test.ts`: Server Actions 테스트
- `__tests__/unit/notes/SummaryGenerateButton.test.tsx`: 버튼 컴포넌트 테스트
- `__tests__/unit/notes/SummaryDisplay.test.tsx`: 표시 컴포넌트 테스트
- `__tests__/unit/gemini/prompts.test.ts`: 프롬프트 유틸리티 테스트

**수정된 파일:**
- `app/actions/notes.ts`: `getNoteById`에 요약 데이터 포함 (Drizzle relations 활용)
- `app/notes/[id]/page.tsx`: 요약 섹션 추가

---

## QA Results

_(QA 검토 시 작성)_

