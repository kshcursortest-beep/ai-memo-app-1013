# Story 1.7: 인증 에러 핸들링

## Status

**Ready for Review**

---

## Story

**As a** 앱 사용자,  
**I want** 인증 과정에서 발생하는 다양한 에러를 명확하게 이해하고 해결할 수 있는 안내,  
**so that** 문제 상황에서도 쉽게 복구하고 서비스를 계속 사용할 수 있습니다.

---

## Acceptance Criteria

1. 모든 인증 관련 에러는 사용자 친화적인 메시지로 표시되어야 한다
2. 네트워크 오류 시 자동 재시도 메커니즘이 작동해야 한다
3. 서버 에러(5xx) 발생 시 일반 사용자가 이해할 수 있는 메시지와 해결 방법을 제공해야 한다
4. 클라이언트 에러(4xx)는 구체적인 문제와 해결 방법을 안내해야 한다
5. 에러 발생 시 사용자가 취할 수 있는 액션(재시도, 로그인, 고객센터)이 명확해야 한다
6. 중요 에러는 로깅 시스템에 기록되어야 한다 (선택사항: Sentry 등)
7. 에러 화면은 반응형이며 접근성이 높아야 한다

---

## Tasks / Subtasks

- [ ] Task 1: 에러 타입 정의 및 분류 (AC: 1, 3, 4)
  - [ ] `lib/types/errors.ts` 생성
  - [ ] 인증 에러 타입 정의:
    - [ ] 네트워크 에러 (Network Error)
    - [ ] 서버 에러 (500, 502, 503, 504)
    - [ ] 클라이언트 에러 (400, 401, 403, 404)
    - [ ] 유효성 검사 에러 (Validation Error)
    - [ ] 세션 만료 에러 (Session Expired)
    - [ ] 권한 에러 (Permission Denied)
  - [ ] 각 에러에 대한 사용자 친화적 메시지 매핑

- [ ] Task 2: 에러 핸들러 유틸리티 구현 (AC: 1, 3, 4, 5)
  - [ ] `lib/utils/errorHandler.ts` 생성
  - [ ] `handleAuthError` 함수: 에러 타입 분석 및 메시지 생성
  - [ ] `getErrorAction` 함수: 에러에 따른 추천 액션 반환
  - [ ] `formatErrorMessage` 함수: 사용자 친화적 메시지 포맷팅

- [ ] Task 3: 자동 재시도 메커니즘 구현 (AC: 2)
  - [ ] `lib/utils/retryHandler.ts` 생성
  - [ ] 지수 백오프(exponential backoff) 재시도 로직
  - [ ] 최대 재시도 횟수 설정 (기본 3회)
  - [ ] 네트워크 오류 및 5xx 에러에만 재시도 적용
  - [ ] 재시도 중 로딩 상태 표시

- [ ] Task 4: 에러 바운더리 컴포넌트 구현 (AC: 1, 5, 7)
  - [ ] `components/error/AuthErrorBoundary.tsx` 생성
  - [ ] React Error Boundary 패턴 적용
  - [ ] 에러 발생 시 fallback UI 표시
  - [ ] 재시도 버튼, 로그인 버튼 등 액션 버튼
  - [ ] 에러 세부 정보 표시 (개발 환경에서만)

- [ ] Task 5: 글로벌 에러 핸들링 통합 (AC: 1, 6)
  - [ ] Server Actions에 에러 핸들러 통합
  - [ ] `app/actions/auth.ts` 수정: handleAuthError 적용
  - [ ] 에러 로깅 추가 (console.error 또는 Sentry)
  - [ ] 에러 발생 시 Toast 알림 표시

- [ ] Task 6: 에러 페이지 구현 (AC: 5, 7)
  - [ ] `app/error.tsx` 생성 (Next.js 에러 페이지)
  - [ ] 일반 에러 페이지 UI
  - [ ] 에러 메시지 및 액션 버튼
  - [ ] 홈으로 돌아가기 버튼

- [ ] Task 7: 특정 에러 시나리오 처리 (AC: 4, 5)
  - [ ] 이메일 미확인 에러: "이메일을 확인해주세요" + 재전송 버튼
  - [ ] 계정 잠김 에러: "계정이 일시적으로 잠겼습니다" + 고객센터 링크
  - [ ] 비밀번호 만료: "비밀번호를 재설정해주세요" + 재설정 페이지 링크
  - [ ] 세션 만료: "세션이 만료되었습니다" + 로그인 페이지 링크

- [ ] Task 8: 에러 로깅 시스템 구축 (AC: 6, 선택사항)
  - [ ] Sentry 또는 LogRocket 통합 (선택사항)
  - [ ] 에러 스택 추적 및 컨텍스트 정보 수집
  - [ ] 프로덕션 환경에서만 활성화

- [ ] Task 9: 단위 테스트 작성
  - [ ] errorHandler 유틸리티 테스트
  - [ ] retryHandler 테스트 (재시도 로직, 백오프)
  - [ ] AuthErrorBoundary 컴포넌트 테스트

- [ ] Task 10: 통합 테스트 작성
  - [ ] 다양한 에러 시나리오 테스트
  - [ ] 네트워크 에러 자동 재시도 테스트
  - [ ] 에러 발생 시 Toast 알림 테스트
  - [ ] 에러 페이지 렌더링 테스트

---

## Dev Notes

### 기술 스택 및 아키텍처 개요
[Source: docs/architecture.md#1-기술-스택]
- **프레임워크:** Next.js (App Router 사용)
- **UI 라이브러리:** shadcn/ui + Tailwind CSS + Radix UI
- **DB/인증:** Supabase (Auth 기능 활용)
- **에러 트래킹:** Sentry (선택사항)
- **호스팅:** Vercel

### 기존 구현 참고사항
[Source: docs/stories/1.1.story.md, 1.2.story.md, 1.3.story.md]
- Supabase 클라이언트 초기화 완료: `lib/supabase/client.ts`, `lib/supabase/server.ts`
- 인증 Server Actions 위치: `app/actions/auth.ts`
- 기존 에러 처리: 각 Server Action에서 개별 처리
- Toast 알림: Sonner 사용 (app/layout.tsx에 이미 통합)
- 테스트 프레임워크: Jest + React Testing Library

### 에러 핸들링 구조
예상 파일 구조:
```
lib/
  types/
    errors.ts            # 에러 타입 정의
  utils/
    errorHandler.ts      # 에러 핸들러 유틸리티
    retryHandler.ts      # 자동 재시도 로직
components/
  error/
    AuthErrorBoundary.tsx  # 에러 바운더리
app/
  error.tsx              # Next.js 에러 페이지
  actions/
    auth.ts              # (수정) 에러 핸들러 통합
```

### 에러 메시지 매핑
| 에러 코드 | 사용자 메시지 | 추천 액션 |
|----------|------------|---------|
| Network Error | "인터넷 연결을 확인해주세요." | 재시도 |
| 500 | "서버에 일시적인 문제가 발생했습니다. 잠시 후 다시 시도해주세요." | 재시도 |
| 401 | "로그인이 필요합니다." | 로그인 페이지로 이동 |
| 403 | "접근 권한이 없습니다." | 홈으로 돌아가기 |
| 404 | "요청한 페이지를 찾을 수 없습니다." | 홈으로 돌아가기 |
| Email not confirmed | "이메일 인증이 필요합니다. 이메일을 확인해주세요." | 인증 이메일 재전송 |
| Session Expired | "세션이 만료되었습니다. 다시 로그인해주세요." | 로그인 페이지로 이동 |

### 재시도 전략
- **지수 백오프(Exponential Backoff):**
  - 1차 재시도: 1초 후
  - 2차 재시도: 2초 후
  - 3차 재시도: 4초 후
- **재시도 대상:**
  - 네트워크 오류 (ECONNREFUSED, ETIMEDOUT)
  - 5xx 서버 에러 (500, 502, 503, 504)
- **재시도 제외:**
  - 4xx 클라이언트 에러 (사용자 입력 문제)
  - 인증 실패 (401, 403)

### React Error Boundary
- Next.js의 `error.tsx` 파일로 자동 에러 바운더리
- 클라이언트 컴포넌트에서 발생한 에러 캐치
- 서버 컴포넌트 에러는 별도 처리 필요

### UI/UX 요구사항
[Source: docs/prd.md#4-Target-Users]
- 에러 메시지는 비기술적 언어로 작성
- 사용자가 취할 수 있는 명확한 액션 제공
- 재시도 중 로딩 스피너 표시
- 에러 화면은 브랜드 일관성 유지

### 보안 고려사항
[Source: docs/architecture.md#3-보안]
- 프로덕션 환경에서 에러 세부 정보 노출 금지
- 에러 로그에 민감한 정보(비밀번호, 토큰) 포함 금지
- 에러 메시지로 시스템 구조 노출 방지

### 성공 지표
[Source: docs/epics/epic-1-user-authentication.md#성공-지표]
- 인증 관련 에러율 1% 미만
- 자동 재시도 성공률 80% 이상

### Testing

#### 테스트 파일 위치
- 단위 테스트: `__tests__/unit/utils/`, `__tests__/unit/error/`
- 통합 테스트: `__tests__/integration/error/`

#### 테스트 프레임워크
[Source: Story 1.1, 1.2 Implementation]
- Jest + React Testing Library
- 테스트 실행: `pnpm test`
- 기존 테스트 설정 활용: `jest.config.mjs`, `jest.setup.mjs`

#### 테스트 요구사항
- errorHandler 유틸리티 테스트 (다양한 에러 타입)
- retryHandler 테스트 (재시도 로직, 백오프 타이밍)
- AuthErrorBoundary 컴포넌트 테스트
- 네트워크 에러 시나리오 테스트
- 서버 에러(5xx) 시나리오 테스트
- 에러 페이지 렌더링 테스트

#### 테스트 커버리지 목표
- 에러 핸들링 로직 100% 커버리지
- 모든 에러 시나리오 테스트

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

_(구현 시 작성)_

### Debug Log References

_(구현 시 작성)_

### Completion Notes List

_(구현 시 작성)_

### File List

_(구현 시 작성)_

---

## QA Results

_(QA 검토 시 작성)_



