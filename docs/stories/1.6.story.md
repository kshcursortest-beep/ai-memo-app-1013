# Story 1.6: 세션 상태 관리

## Status

**Ready for Review**

---

## Story

**As a** 로그인한 사용자,  
**I want** 앱을 사용하는 동안 세션이 자동으로 유지되고 갱신되는 기능,  
**so that** 작업 중 로그아웃되지 않고 안전하게 앱을 사용할 수 있습니다.

---

## Acceptance Criteria

1. 사용자 세션은 브라우저를 닫았다가 다시 열어도 유지되어야 한다 (Remember Me 기능)
2. 세션 만료 시 자동으로 갱신을 시도해야 한다
3. 세션 갱신 실패 시 사용자에게 알림을 표시하고 로그인 페이지로 리다이렉트해야 한다
4. 세션 만료 5분 전 경고 메시지를 표시해야 한다 (선택사항)
5. 여러 탭에서 로그인 상태가 동기화되어야 한다
6. 세션 관련 에러는 명확한 메시지로 사용자에게 전달되어야 한다
7. 백그라운드에서 세션 갱신이 이루어져야 하며, 사용자 작업을 방해하지 않아야 한다

---

## Tasks / Subtasks

- [ ] Task 1: Supabase Auth 세션 설정 검토 (AC: 1, 2)
  - [ ] Supabase Auth 세션 만료 시간 확인 및 설정
  - [ ] 자동 갱신 정책 확인
  - [ ] Refresh token 처리 로직 검토

- [ ] Task 2: 세션 상태 훅 구현 (AC: 1, 2, 5)
  - [ ] `lib/hooks/useSession.ts` 생성
  - [ ] Supabase `onAuthStateChange` 리스너 통합
  - [ ] 세션 변경 감지 및 상태 동기화
  - [ ] 여러 탭 간 세션 동기화 (BroadcastChannel 또는 LocalStorage 이벤트 활용)

- [ ] Task 3: 세션 갱신 로직 구현 (AC: 2, 7)
  - [ ] `lib/utils/sessionManager.ts` 생성
  - [ ] 백그라운드 세션 갱신 (setInterval 또는 Supabase 자동 갱신)
  - [ ] 토큰 만료 전 자동 갱신 시도
  - [ ] 갱신 실패 시 재시도 로직 (최대 3회)

- [ ] Task 4: 세션 만료 경고 구현 (AC: 4)
  - [ ] `components/auth/SessionExpiryWarning.tsx` 생성
  - [ ] shadcn/ui Alert 또는 Toast 컴포넌트 활용
  - [ ] 만료 5분 전 경고 표시
  - [ ] "세션 연장" 버튼 제공

- [ ] Task 5: 세션 만료 시 처리 (AC: 3, 6)
  - [ ] 세션 만료 감지 로직
  - [ ] 로그인 페이지로 리다이렉트
  - [ ] 현재 페이지 URL 저장 (로그인 후 돌아가기)
  - [ ] Toast 알림으로 "세션이 만료되었습니다. 다시 로그인해주세요." 메시지 표시

- [ ] Task 6: 미들웨어 세션 검증 강화 (AC: 3)
  - [ ] `middleware.ts` 수정
  - [ ] 세션 유효성 검사 추가
  - [ ] 만료된 세션 처리

- [ ] Task 7: 에러 핸들링 및 사용자 피드백 (AC: 6)
  - [ ] 세션 갱신 실패 에러 처리
  - [ ] 네트워크 오류 시 사용자 친화적 메시지
  - [ ] Toast 알림 통합

- [ ] Task 8: 단위 테스트 작성
  - [ ] useSession 훅 테스트
  - [ ] sessionManager 유틸리티 테스트
  - [ ] SessionExpiryWarning 컴포넌트 테스트

- [ ] Task 9: 통합 테스트 작성
  - [ ] 세션 자동 갱신 시나리오 테스트
  - [ ] 세션 만료 후 리다이렉트 테스트
  - [ ] 여러 탭 간 세션 동기화 테스트

---

## Dev Notes

### 기술 스택 및 아키텍처 개요
[Source: docs/architecture.md#1-기술-스택]
- **프레임워크:** Next.js (App Router 사용)
- **UI 라이브러리:** shadcn/ui + Tailwind CSS + Radix UI
- **DB/인증:** Supabase (Auth 기능 활용)
- **호스팅:** Vercel

### Supabase Auth 세션 관리
[Source: Supabase Documentation]
- Supabase는 기본적으로 액세스 토큰 (1시간 만료)과 리프레시 토큰 제공
- `onAuthStateChange` 리스너로 세션 변경 감지 가능
- 자동 토큰 갱신 기능 내장 (리프레시 토큰 사용)
- 세션은 쿠키 또는 로컬 스토리지에 저장

### 기존 구현 참고사항
[Source: docs/stories/1.1.story.md, 1.2.story.md, 1.4.story.md]
- Supabase 클라이언트 초기화 완료: `lib/supabase/client.ts`, `lib/supabase/server.ts`
- 인증 Server Actions 위치: `app/actions/auth.ts`
- 미들웨어 인증 검증: `middleware.ts`
- Toast 알림: Sonner 사용 (app/layout.tsx에 이미 통합)
- 테스트 프레임워크: Jest + React Testing Library

### 세션 관리 구조
예상 파일 구조:
```
lib/
  hooks/
    useSession.ts        # 세션 상태 관리 훅
  utils/
    sessionManager.ts    # 세션 갱신 로직
components/
  auth/
    SessionExpiryWarning.tsx  # 세션 만료 경고 컴포넌트
middleware.ts             # (수정) 세션 검증 강화
```

### 세션 동기화 전략
- **BroadcastChannel API** (현대 브라우저):
  - 여러 탭 간 실시간 메시지 전송
  - 한 탭에서 로그아웃 시 모든 탭에서 동기화
- **LocalStorage 이벤트** (폴백):
  - `storage` 이벤트 리스너로 세션 변경 감지
  - 모든 브라우저에서 지원

### 세션 갱신 타이밍
- Supabase 기본 액세스 토큰 만료: 1시간
- 자동 갱신 시도: 만료 5분 전
- 갱신 실패 시 재시도: 1분 간격으로 최대 3회
- 경고 표시: 만료 5분 전

### UI/UX 요구사항
[Source: docs/prd.md#4-Target-Users]
- 세션 갱신은 백그라운드에서 조용히 처리
- 사용자에게 불필요한 알림 최소화
- 세션 만료 경고는 명확하고 간결하게
- 로그인 후 원래 페이지로 돌아갈 수 있어야 함

### 보안 고려사항
[Source: docs/architecture.md#3-보안]
- 리프레시 토큰은 HttpOnly 쿠키로 저장 (XSS 방어)
- 액세스 토큰은 메모리 또는 안전한 스토리지에 저장
- CSRF 토큰 검증 (Next.js Server Actions 기본 제공)
- 세션 고정 공격 방어 (로그인 시 새 세션 생성)

### 성공 지표
[Source: docs/epics/epic-1-user-authentication.md#성공-지표]
- 세션 자동 갱신 성공률 99% 이상
- 세션 관련 에러율 0.5% 미만

### Testing

#### 테스트 파일 위치
- 단위 테스트: `__tests__/unit/auth/`, `__tests__/unit/hooks/`
- 통합 테스트: `__tests__/integration/auth/`

#### 테스트 프레임워크
[Source: Story 1.1, 1.2 Implementation]
- Jest + React Testing Library
- 테스트 실행: `pnpm test`
- 기존 테스트 설정 활용: `jest.config.mjs`, `jest.setup.mjs`

#### 테스트 요구사항
- useSession 훅 테스트 (세션 변경 감지, 동기화)
- sessionManager 테스트 (자동 갱신, 재시도)
- 세션 만료 시나리오 테스트
- 여러 탭 동기화 테스트 (BroadcastChannel 모킹)
- 세션 만료 경고 컴포넌트 테스트

#### 테스트 커버리지 목표
- 핵심 세션 관리 로직 100% 커버리지
- 에러 시나리오 완전 커버

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

_(구현 시 작성)_

### Debug Log References

_(구현 시 작성)_

### Completion Notes List

_(구현 시 작성)_

### File List

_(구현 시 작성)_

---

## QA Results

_(QA 검토 시 작성)_



