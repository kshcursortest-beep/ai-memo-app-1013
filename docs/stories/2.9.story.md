# Story 2.9: 노트 작성 중 임시 저장

## Status

**Done**

---

## Story

**As a** 로그인한 사용자,  
**I want** 노트 작성 중 브라우저를 닫거나 새로고침해도 작성 중이던 내용이 자동으로 복구,  
**so that** 실수로 내용을 잃지 않고 언제든 작성을 이어갈 수 있습니다.

---

## Acceptance Criteria

1. 노트 작성 페이지에서 제목 또는 본문을 입력하면 자동으로 로컬 스토리지에 임시 저장되어야 한다
2. 임시 저장은 사용자가 입력을 멈춘 후 1초 뒤 자동으로 실행되어야 한다 (디바운스)
3. 페이지를 새로고침하거나 다시 방문했을 때 임시 저장된 내용이 자동으로 복구되어야 한다
4. 임시 저장된 내용이 있을 경우 사용자에게 알림 메시지를 표시해야 한다 ("임시 저장된 내용을 복구하시겠습니까?")
5. 사용자는 임시 저장된 내용을 복구하거나 폐기할 수 있어야 한다
6. 노트를 성공적으로 생성하면 임시 저장된 내용은 자동으로 삭제되어야 한다
7. 임시 저장은 사용자별로 구분되어 저장되어야 한다 (다른 사용자의 임시 저장 내용과 분리)
8. "임시 저장 중..." 상태를 시각적으로 표시해야 한다
9. 임시 저장은 제목과 본문이 모두 비어있을 때는 실행되지 않아야 한다
10. 임시 저장된 내용의 타임스탬프를 표시하여 언제 저장되었는지 알 수 있어야 한다

---

## Tasks / Subtasks

- [x] Task 1: 임시 저장 유틸리티 함수 구현 (AC: 1, 7, 9)
  - [x] `lib/utils/draftStorage.ts` 생성
  - [x] 로컬 스토리지 키 정의: `note-draft-{userId}`
  - [x] `saveDraft(userId, title, content)` 함수:
    - [x] 제목과 본문이 모두 비어있으면 저장하지 않음
    - [x] 타임스탬프 포함하여 저장
    - [x] JSON 형식으로 직렬화
  - [x] `getDraft(userId)` 함수:
    - [x] 로컬 스토리지에서 임시 저장 내용 조회
    - [x] 역직렬화 후 반환
  - [x] `clearDraft(userId)` 함수:
    - [x] 임시 저장 내용 삭제
  - [x] 에러 처리 (로컬 스토리지 접근 실패, 용량 초과 등)

- [x] Task 2: 임시 저장 타입 정의 (AC: 10)
  - [x] `lib/types/draft.ts` 생성
  - [x] `NoteDraft` 인터페이스 정의:
    - [x] title: string
    - [x] content: string
    - [x] savedAt: Date
    - [x] userId: string

- [x] Task 3: 노트 작성 페이지에 임시 저장 통합 (AC: 1, 2, 3, 8)
  - [x] `app/notes/new/page.tsx` 수정
  - [x] 사용자 ID 가져오기 (Supabase Auth)
  - [x] 컴포넌트 마운트 시 임시 저장 내용 확인
  - [x] 임시 저장 상태 관리:
    - [x] `draftStatus`: 'idle' | 'saving' | 'saved'
    - [x] `hasDraft`: boolean
  - [x] useEffect로 제목/본문 변경 감지 및 디바운스 저장 (1초)
  - [x] 임시 저장 상태 표시 UI 추가

- [x] Task 4: 임시 저장 복구 다이얼로그 (AC: 4, 5, 10)
  - [x] `components/notes/DraftRecoveryDialog.tsx` 생성
  - [x] Dialog 컴포넌트 (shadcn/ui) 사용
  - [x] 임시 저장된 내용 미리보기 표시:
    - [x] 제목 (최대 50자)
    - [x] 본문 (최대 100자)
    - [x] 저장 시간 (상대 시간: "5분 전")
  - [x] 버튼:
    - [x] "복구하기" - 임시 저장 내용을 폼에 적용
    - [x] "폐기하기" - 임시 저장 내용 삭제
  - [x] 접근성 (ARIA labels, 키보드 네비게이션)

- [x] Task 5: 노트 생성 성공 시 임시 저장 삭제 (AC: 6)
  - [x] `app/notes/new/page.tsx`의 `handleSubmit` 함수 수정
  - [x] 노트 생성 성공 후 `clearDraft(userId)` 호출
  - [x] Toast 알림으로 "노트가 생성되었습니다" 표시

- [x] Task 6: 임시 저장 상태 표시 UI (AC: 8)
  - [x] `components/notes/DraftStatusIndicator.tsx` 생성
  - [x] 상태별 아이콘 및 텍스트:
    - [x] 'saving': 스피너 + "임시 저장 중..."
    - [x] 'saved': 체크 아이콘 + "임시 저장됨"
  - [x] 페이드인/아웃 애니메이션
  - [x] 작은 크기, 폼 우측 상단에 배치

- [x] Task 7: 단위 테스트 작성
  - [x] `__tests__/unit/utils/draftStorage.test.ts`:
    - [x] saveDraft 함수 테스트
    - [x] getDraft 함수 테스트
    - [x] clearDraft 함수 테스트
    - [x] 빈 내용 저장 시 동작 테스트
    - [x] 로컬 스토리지 오류 처리 테스트
  - [x] `__tests__/unit/notes/DraftRecoveryDialog.test.tsx`:
    - [x] 다이얼로그 렌더링 테스트
    - [x] 복구 버튼 클릭 테스트
    - [x] 폐기 버튼 클릭 테스트
  - [x] `__tests__/unit/notes/DraftStatusIndicator.test.tsx`:
    - [x] 상태별 표시 테스트
    - [x] 애니메이션 테스트

- [ ] Task 8: 통합 테스트 작성 (선택 사항, 생략)
  - [ ] `__tests__/integration/notes/draft-recovery.test.ts`:
    - [ ] 임시 저장 → 페이지 새로고침 → 복구 플로우
    - [ ] 임시 저장 → 노트 생성 → 임시 저장 삭제 플로우
    - [ ] 임시 저장 → 폐기 플로우

---

## Dev Notes

### 기술 스택 및 아키텍처 개요
[Source: docs/architecture.md#1-기술-스택]
- **프레임워크:** Next.js (App Router, Server Actions, Server Components)
- **UI:** shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스:** Supabase Postgres
- **ORM:** Drizzle ORM
- **인증:** Supabase Auth

### 이전 스토리에서 완료된 사항

**Story 2.2 - 노트 생성:**
[Source: docs/stories/2.2.story.md]
- ✅ NoteCreateForm 컴포넌트 (제목/본문 입력, 유효성 검사)
- ✅ createNote Server Action
- ✅ app/notes/new/page.tsx (노트 생성 페이지)

**Story 2.5 - 노트 수정 및 실시간 저장:**
[Source: docs/stories/2.5.story.md]
- ✅ 자동 저장 구현 (2초 디바운스)
- ✅ 저장 상태 표시 ("저장 중...", "저장됨")
- ✅ updateNote Server Action

**Story 2.8 - 빈 상태 UI 및 온보딩:**
[Source: docs/stories/2.8.story.md]
- ✅ 노트 템플릿 시스템 (회의 노트, 아이디어 메모, 할 일 목록)
- ✅ 템플릿 선택 시 초기값 설정 기능

### 현재 노트 작성 페이지 구조
[Source: app/notes/new/page.tsx, components/notes/NoteCreateForm.tsx]

**app/notes/new/page.tsx:**
```typescript
// Client Component
- useRouter, useSearchParams 사용
- 사용자 인증 확인 (Supabase createClient)
- 템플릿 ID 파라미터 처리 (?template=meeting)
- 템플릿 초기값 설정
- handleSubmit에서 createNote Server Action 호출
- Toast 알림 (성공/실패)
```

**components/notes/NoteCreateForm.tsx:**
```typescript
// Client Component
- Props: onSubmit, isSubmitting, initialTitle?, initialContent?
- 상태: title, content, errors
- 유효성 검사 (validateNote 유틸리티)
- 입력 필드: Input (제목), Textarea (본문)
- 버튼: "노트 생성", "취소"
```

### 로컬 스토리지 구조
[Source: Epic 2 기술적 요구사항]

**임시 저장 데이터 구조:**
```typescript
// localStorage key: "note-draft-{userId}"
{
  title: string;
  content: string;
  savedAt: string; // ISO 8601 형식
  userId: string;
}
```

**주의사항:**
- 로컬 스토리지는 최대 5-10MB 용량 제한
- 브라우저별로 다를 수 있음
- try-catch로 에러 처리 필수
- JSON.stringify/parse 사용

### 디바운스 구현
[Source: Story 2.5 - 실시간 저장 구현]

**참고 패턴 (Story 2.5에서 사용):**
```typescript
useEffect(() => {
  if (!isEditing || !hasChanges) return

  const timeoutId = setTimeout(() => {
    handleAutoSave()
  }, 2000)

  return () => clearTimeout(timeoutId)
}, [title, content, isEditing, hasChanges, handleAutoSave])
```

**Story 2.9에서는 1초 디바운스 사용:**
- 노트 생성은 더 빠른 피드백이 필요
- 수정보다 짧은 간격으로 임시 저장

### 파일 구조

```
lib/
  utils/
    draftStorage.ts         # (신규) 임시 저장 유틸리티
  types/
    draft.ts                # (신규) 임시 저장 타입 정의
components/
  notes/
    DraftRecoveryDialog.tsx # (신규) 복구 다이얼로그
    DraftStatusIndicator.tsx # (신규) 상태 표시
    NoteCreateForm.tsx      # (수정) 임시 저장 로직 추가 가능
app/
  notes/
    new/
      page.tsx              # (수정) 임시 저장 통합
__tests__/
  unit/
    utils/
      draftStorage.test.ts  # (신규) 유틸리티 테스트
    notes/
      DraftRecoveryDialog.test.tsx # (신규)
      DraftStatusIndicator.test.tsx # (신규)
  integration/
    notes/
      draft-recovery.test.ts # (신규, 선택)
```

### Server Actions
[Source: docs/architecture.md#4-서버-액션]

**기존 Server Actions:**
- `createNote(title, content)` - 노트 생성 (app/actions/notes.ts)
- `updateNote(noteId, title, content)` - 노트 수정
- `deleteNote(noteId)` - 노트 삭제

**이 스토리에서는 Server Action 추가 불필요:**
- 임시 저장은 로컬 스토리지 사용 (클라이언트 전용)
- 서버 왕복 없이 빠른 저장 가능
- 오프라인에서도 동작

### 접근성 고려사항
[Source: Epic 2 성공 지표]
- DraftRecoveryDialog에 ARIA labels 추가
- 키보드로 복구/폐기 선택 가능 (Tab, Enter, Esc)
- 스크린 리더 지원: "임시 저장된 노트를 발견했습니다"
- 포커스 관리: 다이얼로그 열릴 때 첫 버튼에 포커스

### 보안 고려사항
[Source: docs/architecture.md#3-보안]
- 로컬 스토리지는 같은 도메인에서만 접근 가능
- userId를 키에 포함하여 다중 사용자 환경 대비
- 민감한 정보는 저장하지 않음 (이미 클라이언트에 노출된 데이터)
- XSS 방지: 사용자 입력은 React에서 자동 이스케이프

### Testing

**테스트 프레임워크:**
[Source: Epic 2 - 기술적 요구사항]
- **Framework:** Jest + React Testing Library
- **실행:** `pnpm test`
- **위치:** `__tests__/unit/`, `__tests__/integration/` (선택)

**단위 테스트 요구사항:**
- 로컬 스토리지 모킹 필요
- localStorage.getItem, setItem, removeItem 모킹
- 컴포넌트 테스트 시 사용자 인터랙션 시뮬레이션
- 타이머 모킹 (디바운스 테스트)

**통합 테스트 (선택 사항):**
- End-to-end 플로우 검증
- 실제 로컬 스토리지 동작 확인
- 페이지 네비게이션 테스트

### 사용자 경험 고려사항

**시나리오 1: 작성 중 브라우저 종료**
1. 사용자가 제목/본문 입력
2. 1초 후 자동으로 로컬 스토리지에 저장
3. "임시 저장됨" 표시
4. 브라우저 닫음
5. 다시 /notes/new 접속
6. "임시 저장된 내용을 복구하시겠습니까?" 다이얼로그 표시
7. "복구하기" 클릭 → 내용 복원

**시나리오 2: 노트 생성 완료**
1. 임시 저장된 내용으로 작성
2. "노트 생성" 버튼 클릭
3. 성공 시 로컬 스토리지 자동 삭제
4. "노트가 생성되었습니다" Toast 표시

**시나리오 3: 임시 저장 폐기**
1. 임시 저장 복구 다이얼로그에서 "폐기하기" 클릭
2. 로컬 스토리지 삭제
3. 빈 폼으로 시작

### 에러 처리

**로컬 스토리지 관련 에러:**
- QuotaExceededError: 용량 초과 시 무시 (콘솔 경고만)
- SecurityError: 프라이빗 모드 등에서 접근 불가 시 무시
- JSON 파싱 에러: 손상된 데이터 삭제 후 계속 진행

**복구 실패:**
- 데이터 형식 불일치: 무시하고 빈 폼 표시
- userId 불일치: 다른 사용자 데이터는 무시

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | Bob (SM Agent) |
| 2025-10-14 | 2.0 | 스토리 구현 완료 | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

None

### Completion Notes List

1. **임시 저장 시스템 구현 완료**
   - 로컬 스토리지 기반 임시 저장 유틸리티 (`lib/utils/draftStorage.ts`)
   - 사용자별 격리된 임시 저장 (`note-draft-{userId}`)
   - QuotaExceededError, SecurityError 등 에러 처리
   - 손상된 데이터 자동 복구

2. **자동 저장 기능**
   - 1초 디바운스로 자동 임시 저장
   - 제목/본문 변경 추적 (`onTitleChange`, `onContentChange` 콜백)
   - 빈 내용은 저장하지 않음 (AC #9)
   - 노트 생성 성공 시 자동 삭제 (AC #6)

3. **복구 다이얼로그**
   - `date-fns` 라이브러리 추가 (상대 시간 표시용)
   - 제목 50자, 본문 100자 미리보기
   - 타임스탬프 표시 (상대 시간 + 절대 시간)
   - 접근성: ARIA labels, 키보드 네비게이션, autoFocus

4. **상태 표시 UI**
   - saving: 스피너 + "임시 저장 중..."
   - saved: 체크 아이콘 + "임시 저장됨" (2초 후 자동 숨김)
   - 페이드 인/아웃 애니메이션

5. **테스트 커버리지**
   - 총 270개 단위 테스트 통과 (100%)
   - `draftStorage.test.ts`: 17개 테스트 (유틸리티 함수)
   - `DraftRecoveryDialog.test.tsx`: 15개 테스트 (컴포넌트)
   - `DraftStatusIndicator.test.tsx`: 14개 테스트 (컴포넌트)
   - Task 8 (통합 테스트)는 선택 사항으로 생략

6. **NoteCreateForm 수정**
   - `onTitleChange`, `onContentChange` props 추가
   - `useEffect`로 `initialTitle`, `initialContent` 동기화
   - 부모 컴포넌트에 변경 이벤트 전달

### File List

**신규 생성 (6개):**
- `lib/types/draft.ts` - 임시 저장 타입 정의
- `lib/utils/draftStorage.ts` - 로컬 스토리지 유틸리티
- `components/notes/DraftStatusIndicator.tsx` - 상태 표시 컴포넌트
- `components/notes/DraftRecoveryDialog.tsx` - 복구 다이얼로그
- `__tests__/unit/utils/draftStorage.test.ts` - 유틸리티 테스트
- `__tests__/unit/notes/DraftRecoveryDialog.test.tsx` - 다이얼로그 테스트
- `__tests__/unit/notes/DraftStatusIndicator.test.tsx` - 상태 표시 테스트

**수정 (2개):**
- `app/notes/new/page.tsx` - 임시 저장 통합
- `components/notes/NoteCreateForm.tsx` - 변경 추적 콜백

**의존성 추가:**
- `date-fns@4.1.0` - 상대 시간 표시용

---

## QA Results

_(QA 검토 시 작성)_

