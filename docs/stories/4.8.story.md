# Story 4.8: 토큰 사용량 모니터링

## Status
Draft

---

## Story
**As a** 사용자,
**I want** AI 기능 사용 시 토큰 사용량을 실시간으로 확인할 수 있도록,
**so that** API 비용을 관리하고 사용량을 제어할 수 있다

---

## Acceptance Criteria
1. AI 요약 생성 시 사용된 토큰 수가 표시된다
2. AI 태그 생성 시 사용된 토큰 수가 표시된다
3. 일일 토큰 사용량이 대시보드에 표시된다
4. 월별 토큰 사용량 통계가 제공된다
5. 토큰 사용량이 제한에 근접하면 경고가 표시된다
6. 토큰 사용량 히스토리를 조회할 수 있다
7. 사용량이 많은 기능에 대한 최적화 제안이 제공된다
8. 관리자는 전체 사용량을 모니터링할 수 있다

---

## Tasks / Subtasks
- [ ] 토큰 사용량 추적 시스템 구현 (AC: 1, 2, 3, 4)
  - [ ] 토큰 사용량 기록 테이블 추가
  - [ ] AI 요청 시 토큰 수 계산 및 저장
  - [ ] 일일/월별 사용량 집계 로직
  - [ ] 사용량 조회 API 구현
- [ ] 사용량 표시 UI 구현 (AC: 1, 2, 3, 4, 5)
  - [ ] AI 처리 완료 시 토큰 수 표시
  - [ ] 대시보드 사용량 위젯
  - [ ] 사용량 경고 알림
  - [ ] 사용량 히스토리 차트
- [ ] 최적화 제안 시스템 구현 (AC: 7, 8)
  - [ ] 사용량 패턴 분석
  - [ ] 최적화 제안 알고리즘
  - [ ] 관리자 모니터링 대시보드

---

## Dev Notes

### 이전 스토리에서의 인사이트
- Story 4.1 (Gemini API 설정): API 비용 관리의 중요성
- Story 4.2 (요약 생성): 요약 생성 시 토큰 사용량이 많음
- Story 4.3 (태그 생성): 태그 생성은 상대적으로 토큰 사용량이 적음
- Story 4.5 (재생성 기능): 재생성 시 추가 토큰 사용

### 데이터 모델
- 새로운 테이블 추가:
  ```sql
  CREATE TABLE token_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    note_id UUID REFERENCES notes(id),
    operation_type VARCHAR(20) NOT NULL, -- 'summary', 'tags', 'regeneration'
    input_tokens INTEGER NOT NULL,
    output_tokens INTEGER NOT NULL,
    total_tokens INTEGER NOT NULL,
    cost_usd DECIMAL(10,6),
    created_at TIMESTAMP DEFAULT NOW()
  );
  ```

### API 명세
- 새로운 Server Actions 추가:
  - `recordTokenUsage(userId, noteId, operationType, inputTokens, outputTokens)` - 사용량 기록
  - `getTokenUsage(userId, period)` - 사용량 조회
  - `getTokenUsageStats(userId)` - 사용량 통계
  - `checkTokenLimit(userId)` - 사용량 제한 확인

### 컴포넌트 명세
- `TokenUsageDisplay.tsx` - 토큰 사용량 표시 컴포넌트
- `UsageDashboard.tsx` - 사용량 대시보드
- `UsageChart.tsx` - 사용량 차트
- `UsageAlert.tsx` - 사용량 경고 알림
- `AdminUsageMonitor.tsx` - 관리자 모니터링

### 파일 위치
- `drizzle/schema.ts` - `tokenUsage` 테이블 추가
- `app/actions/token-usage.ts` - 토큰 사용량 관련 Server Actions
- `components/ui/token-usage-display.tsx` - 토큰 사용량 표시
- `components/ui/usage-dashboard.tsx` - 사용량 대시보드
- `components/ui/usage-chart.tsx` - 사용량 차트
- `lib/utils/token-calculator.ts` - 토큰 수 계산 유틸리티

### 테스트 요구사항
- 토큰 사용량 기록 테스트
- 사용량 조회 및 집계 테스트
- 사용량 제한 확인 테스트
- UI 컴포넌트 렌더링 테스트
- 사용량 경고 시스템 테스트

### 기술적 제약사항
- Gemini API의 토큰 계산 정확성
- 실시간 사용량 업데이트
- 대용량 데이터 처리 성능
- 사용량 데이터의 개인정보 보호

---

## Testing

### 테스트 파일 위치
- `__tests__/unit/actions/token-usage.test.ts` - 토큰 사용량 Server Actions 테스트
- `__tests__/unit/components/ui/token-usage-display.test.tsx` - 토큰 사용량 표시 테스트
- `__tests__/unit/components/ui/usage-dashboard.test.tsx` - 사용량 대시보드 테스트
- `__tests__/unit/components/ui/usage-chart.test.tsx` - 사용량 차트 테스트
- `__tests__/unit/utils/token-calculator.test.ts` - 토큰 계산 테스트
- `__tests__/integration/token-monitoring.test.ts` - 통합 테스트

### 테스트 표준
- Jest + React Testing Library 사용
- 토큰 사용량 계산 정확성 테스트
- 사용량 집계 로직 테스트
- UI 컴포넌트 렌더링 테스트
- 사용량 경고 시스템 테스트

### 특정 테스트 요구사항
- AI 요약 생성 시 토큰 수 정확한 계산 확인
- AI 태그 생성 시 토큰 수 정확한 계산 확인
- 일일 토큰 사용량 집계 정확성 확인
- 월별 토큰 사용량 통계 정확성 확인
- 사용량 제한 근접 시 경고 표시 확인
- 사용량 히스토리 조회 기능 확인

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 문서 생성 | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
*개발 에이전트가 구현 시 기록*

### Debug Log References
*개발 에이전트가 구현 시 기록*

### Completion Notes List
*개발 에이전트가 구현 시 기록*

### File List
*개발 에이전트가 구현 시 기록*

---

## QA Results
*QA 에이전트가 검토 시 기록*
