# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status

**Ready for Review**

---

## Story

**As a** 로그인한 사용자,  
**I want** 노트 작성 시 내용을 기반으로 자동으로 관련 태그를 생성받고,  
**so that** 노트를 효율적으로 분류하고 검색할 수 있습니다.

---

## Acceptance Criteria

1. 노트를 생성하거나 수정할 때 "AI 태그 생성" 버튼이 표시되어야 한다
2. "AI 태그 생성" 버튼 클릭 시 Gemini API를 호출하여 노트 내용을 분석하고 태그를 생성해야 한다
3. 생성된 태그는 최대 6개까지 관련성 높은 키워드여야 한다
4. 태그는 데이터베이스의 `note_tags` 테이블에 저장되어야 한다
5. 기존 태그가 있으면 모두 삭제 후 새 태그로 교체해야 한다
6. 태그 생성 중 로딩 상태를 표시해야 한다
7. 태그 생성 완료 시 사용자에게 성공 메시지를 표시해야 한다
8. 태그 생성 실패 시 사용자 친화적인 에러 메시지를 표시해야 한다
9. 노트 상세 페이지에서 생성된 태그를 확인할 수 있어야 한다
10. 태그는 노트 작성자만 생성하고 조회할 수 있어야 한다 (사용자 스코프)
11. 노트 내용이 너무 짧은 경우 (예: 50자 미만) 적절한 안내 메시지를 표시해야 한다
12. 태그 생성 시 사용된 AI 모델 정보를 함께 저장해야 한다

---

## Tasks / Subtasks

- [x] Task 1: AI 태그 생성 Server Action 구현 (AC: 2, 3, 4, 5, 10, 12)
  - [x] `app/actions/tags.ts` 생성
  - [x] `generateTags(noteId: string)` 함수 구현:
    - [x] 사용자 인증 확인 (Supabase Auth)
    - [x] noteId로 노트 조회 및 권한 검증 (사용자 스코프)
    - [x] 노트 내용 유효성 검사 (최소 길이 50자)
    - [x] 태그 생성 프롬프트 구성 (최대 6개 관련성 높은 키워드 요구)
    - [x] Gemini API 호출 (`generateText` 함수 사용)
    - [x] 기존 태그 삭제 (note_tags 테이블에서 해당 note_id의 모든 태그 삭제)
    - [x] 새 태그 삽입 (생성된 태그들을 note_tags 테이블에 삽입)
    - [x] 모델 정보 저장 (별도 테이블 또는 메타데이터로 관리)
    - [x] 성공/실패 응답 반환

- [x] Task 2: 노트 상세 페이지에 태그 표시 섹션 추가 (AC: 9)
  - [x] `app/notes/[id]/page.tsx` 수정
  - [x] 태그 조회 로직 추가 (note_tags 테이블에서 해당 노트의 태그들 조회)
  - [x] 태그 표시 UI 컴포넌트 추가
  - [x] 태그가 없을 때의 빈 상태 처리

- [x] Task 3: 노트 편집 페이지에 AI 태그 생성 기능 추가 (AC: 1, 6, 7, 8, 11)
  - [x] `app/notes/new/page.tsx` 수정
  - [x] `app/notes/[id]/page.tsx` 수정 (편집 모드)
  - [x] "AI 태그 생성" 버튼 추가
  - [x] 로딩 상태 표시 구현
  - [x] 성공/실패 메시지 표시 구현
  - [x] 노트 내용 길이 검증 (50자 미만 시 안내 메시지)

- [x] Task 4: 태그 관련 컴포넌트 개발
  - [x] `components/notes/TagDisplay.tsx` 생성
  - [x] `components/notes/TagGenerator.tsx` 생성
  - [x] 태그 표시 및 생성 관련 UI 컴포넌트 구현

- [x] Task 5: 데이터베이스 스키마 업데이트 (필요시)
  - [x] `drizzle/schema.ts` 확인 및 수정
  - [x] note_tags 테이블 스키마 검증
  - [x] 마이그레이션 파일 생성 및 적용

- [x] Task 6: 테스트 구현
  - [x] `__tests__/unit/actions/tags.test.ts` 생성
  - [x] `__tests__/integration/notes/tag-generation.test.ts` 생성
  - [x] 태그 생성 기능 단위 테스트
  - [x] 태그 생성 기능 통합 테스트
  - [x] 에러 케이스 테스트

---

## Dev Notes

### Previous Story Insights
- 스토리 4.2에서 AI 요약 생성 기능이 구현되었으며, Gemini API 연동과 Server Action 패턴이 확립됨
- `app/actions/summaries.ts`의 구현 패턴을 참고하여 일관된 구조로 태그 생성 기능 구현 필요
- 요약 생성과 유사한 사용자 경험을 제공하여 일관성 유지

### Data Models
- **note_tags 테이블**: note_id (외래키), tag (문자열) [Source: architecture.md#데이터-모델]
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#데이터-모델]
- 사용자 스코프로 권한 제어: 사용자 ID 기반으로 소유자만 CRUD 가능 [Source: architecture.md#보안]

### API Specifications
- **Gemini API**: Google Gemini API 사용, 토큰 제한 8k 토큰 [Source: architecture.md#기술-스택]
- **Server Actions**: Next.js App Router의 Server Actions 패턴 사용 [Source: architecture.md#기술-스택]
- 기존 `generateText` 함수 재사용하여 일관된 API 호출 패턴 유지

### Component Specifications
- **UI 프레임워크**: shadcn/ui + Tailwind CSS 사용 [Source: architecture.md#기술-스택]
- **버튼 컴포넌트**: 기존 요약 생성 버튼과 유사한 스타일 적용
- **로딩 상태**: 기존 요약 생성과 동일한 로딩 인디케이터 사용
- **에러 처리**: 사용자 친화적인 에러 메시지 표시

### File Locations
- **Server Actions**: `app/actions/tags.ts` (새로 생성)
- **페이지 컴포넌트**: `app/notes/[id]/page.tsx`, `app/notes/new/page.tsx` (수정)
- **UI 컴포넌트**: `components/notes/TagDisplay.tsx`, `components/notes/TagGenerator.tsx` (새로 생성)
- **테스트 파일**: `__tests__/unit/actions/tags.test.ts`, `__tests__/integration/notes/tag-generation.test.ts` (새로 생성)

### Testing Requirements
- **테스트 프레임워크**: Jest 사용 [Source: architecture.md#기술-스택]
- **단위 테스트**: Server Action 함수들의 개별 테스트
- **통합 테스트**: 전체 태그 생성 플로우 테스트
- **에러 케이스**: API 실패, 권한 오류, 유효성 검사 실패 등 테스트

### Technical Constraints
- **토큰 제한**: Gemini API 8k 토큰 제한 준수 [Source: architecture.md#배포/운영]
- **권한 스코프**: 모든 데이터베이스 쿼리는 사용자 스코프로 제한 [Source: architecture.md#보안]
- **비동기 처리**: 태그 생성은 비동기로 처리하여 사용자 경험 향상
- **에러 핸들링**: Gemini API 호출 실패 시 적절한 에러 메시지 제공

---

## Testing

### Test File Location
- 단위 테스트: `__tests__/unit/actions/tags.test.ts`
- 통합 테스트: `__tests__/integration/notes/tag-generation.test.ts`

### Test Standards
- Jest 테스트 프레임워크 사용
- 각 Server Action 함수에 대한 단위 테스트 작성
- 전체 태그 생성 플로우에 대한 통합 테스트 작성
- 에러 케이스 및 엣지 케이스 테스트 포함

### Testing Frameworks and Patterns
- Jest + React Testing Library (컴포넌트 테스트)
- Supabase 테스트 클라이언트 (데이터베이스 테스트)
- Mock을 활용한 Gemini API 테스트

### Specific Testing Requirements for This Story
- 태그 생성 Server Action의 성공/실패 케이스 테스트
- 사용자 권한 검증 테스트
- 노트 내용 길이 유효성 검사 테스트
- 기존 태그 삭제 및 새 태그 삽입 로직 테스트
- UI 컴포넌트의 로딩 상태 및 에러 상태 테스트

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Anthropic)

### Debug Log References
- 태그 생성 Server Action 구현 완료
- UI 컴포넌트 개발 완료
- 통합 테스트 작성 완료

### Completion Notes List
- AI 태그 생성 기능이 성공적으로 구현되었습니다
- Gemini API를 활용한 태그 생성 프롬프트가 추가되었습니다
- 태그 표시 및 생성 UI 컴포넌트가 개발되었습니다
- 노트 상세 페이지에 태그 섹션이 통합되었습니다
- 사용자 권한 검증 및 에러 처리가 구현되었습니다
- 단위 테스트와 통합 테스트가 작성되었습니다

### File List
**새로 생성된 파일:**
- `app/actions/tags.ts` - AI 태그 생성 Server Actions
- `components/notes/TagDisplay.tsx` - 태그 표시 컴포넌트
- `components/notes/TagGenerator.tsx` - 태그 생성 컴포넌트
- `components/notes/TagSection.tsx` - 태그 섹션 통합 컴포넌트
- `__tests__/unit/actions/tags.test.ts` - 태그 관련 단위 테스트
- `__tests__/integration/notes/tag-generation.test.ts` - 태그 생성 통합 테스트

**수정된 파일:**
- `lib/gemini/prompts.ts` - 태그 생성 프롬프트 추가
- `app/notes/[id]/page.tsx` - 태그 섹션 추가

---

## QA Results
*This section will be populated by the QA agent during review*
