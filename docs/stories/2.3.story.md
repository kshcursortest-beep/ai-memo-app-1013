# Story 2.3: 노트 목록 조회 및 페이지네이션

## Status

**Done**

---

## Story

**As a** 로그인한 사용자,  
**I want** 내가 작성한 노트 목록을 최신순으로 조회하고 페이지네이션으로 탐색,  
**so that** 많은 노트를 효율적으로 관리하고 원하는 노트를 빠르게 찾을 수 있습니다.

---

## Acceptance Criteria

1. 사용자는 자신이 작성한 노트 목록을 볼 수 있어야 한다 (다른 사용자의 노트는 보이지 않음)
2. 노트 목록은 최신순(created_at 내림차순)으로 정렬되어야 한다
3. 한 페이지에 10개의 노트를 표시하고, 10개를 초과하면 페이지네이션이 활성화되어야 한다
4. 각 노트 카드는 제목, 본문 미리보기(첫 100자), 작성일시를 표시해야 한다
5. 노트가 없는 경우 빈 상태(Empty State) UI를 표시하고 "새 노트 작성" 버튼을 제공해야 한다
6. 페이지네이션은 "이전/다음" 버튼과 현재 페이지 번호를 표시해야 한다
7. 노트 목록 로딩 중에는 스켈레톤 UI 또는 로딩 인디케이터를 표시해야 한다
8. 노트 카드를 클릭하면 해당 노트의 상세 페이지로 이동해야 한다 (2.4 스토리에서 구현)
9. 모바일과 데스크톱 모두에서 반응형으로 동작해야 한다

---

## Tasks / Subtasks

- [x] Task 1: 노트 목록 조회 Server Action 구현 (AC: 1, 2, 3, 6)
  - [x] `app/actions/notes.ts`에 `getNotes` Server Action 함수 추가
  - [x] 사용자 인증 상태 확인 (Supabase Auth)
  - [x] Drizzle ORM으로 notes 테이블 쿼리:
    - [x] WHERE user_id = 현재 사용자 ID
    - [x] ORDER BY created_at DESC
    - [x] LIMIT/OFFSET으로 페이지네이션 구현
  - [x] 전체 노트 개수 조회 (페이지네이션 계산용)
  - [x] 반환 데이터: { notes: Note[], total: number, page: number, pageSize: number }
  - [x] 에러 핸들링 (DB 오류, 인증 오류)

- [x] Task 2: 노트 목록 UI 컴포넌트 (AC: 4, 5, 9)
  - [x] `components/notes/NoteList.tsx` 생성
  - [x] 노트 카드 컴포넌트 구현:
    - [x] 제목 표시 (최대 2줄, 말줄임)
    - [x] 본문 미리보기 (첫 100자, 말줄임)
    - [x] 작성일시 표시 (상대 시간 또는 절대 시간)
  - [x] 빈 상태 UI 구현:
    - [x] 아이콘/일러스트레이션
    - [x] 안내 메시지 ("아직 작성한 노트가 없습니다")
    - [x] "새 노트 작성" 버튼 (헤더 버튼과 동일 동작)
  - [x] 반응형 그리드 레이아웃 (모바일: 1열, 태블릿: 2열, 데스크톱: 3열)

- [x] Task 3: 페이지네이션 컴포넌트 (AC: 3, 6)
  - [x] `components/notes/NotePagination.tsx` 생성
  - [x] 이전/다음 버튼 구현
  - [x] 현재 페이지/전체 페이지 표시
  - [x] 첫 페이지/마지막 페이지에서 버튼 비활성화
  - [x] URL 쿼리 파라미터로 페이지 상태 관리 (?page=1)
  - [x] shadcn/ui Button 컴포넌트 활용

- [x] Task 4: 노트 목록 페이지 (AC: 1, 7)
  - [x] `app/page.tsx` 수정 (또는 `app/notes/page.tsx` 생성)
  - [x] Server Component로 구현하여 초기 데이터 SSR
  - [x] URL 쿼리 파라미터에서 페이지 번호 읽기
  - [x] getNotes Server Action 호출 및 데이터 렌더링
  - [x] NoteList 및 NotePagination 컴포넌트 통합
  - [x] 로딩 상태 처리 (loading.tsx 또는 Suspense)

- [x] Task 5: 로딩 및 에러 상태 UI (AC: 7)
  - [x] `app/loading.tsx` 또는 스켈레톤 UI 컴포넌트 생성
  - [x] 노트 카드 스켈레톤 (제목/본문/날짜 영역 표시)
  - [x] 에러 상태 UI (app/error.tsx 활용 또는 ErrorBoundary)
  - [x] 데이터 로딩 실패 시 재시도 버튼 제공

- [x] Task 6: 사용자 인증 확인 (AC: 1)
  - [x] 미들웨어 또는 페이지 레벨에서 로그인 상태 확인
  - [x] 미인증 사용자는 로그인 페이지로 리다이렉트
  - [x] 기존 middleware.ts 활용 또는 확장

- [x] Task 7: UI/UX 개선 (AC: 4, 9)
  - [x] 노트 카드 hover 효과 (그림자, 스케일 등)
  - [x] 날짜 포맷팅 유틸리티 함수 작성 (예: "2분 전", "2025-10-14")
  - [x] 접근성 (ARIA labels, 키보드 네비게이션)
  - [x] 반응형 디자인 테스트 (모바일/태블릿/데스크톱)

- [x] Task 8: 단위 테스트 작성
  - [x] `__tests__/unit/actions/notes.test.ts`에 getNotes 테스트 추가
  - [x] getNotes Server Action 테스트:
    - [x] 정상적인 노트 목록 조회
    - [x] 페이지네이션 동작 확인 (page 1, 2, ...)
    - [x] 사용자 스코프 검증 (다른 사용자 노트 제외)
    - [x] 최신순 정렬 검증
    - [x] 빈 목록 처리
  - [x] `__tests__/unit/notes/NoteList.test.tsx` 생성
  - [x] 노트 카드 렌더링 테스트
  - [x] 빈 상태 UI 렌더링 테스트

- [x] Task 9: 통합 테스트 작성
  - [x] `__tests__/integration/notes/list-notes.test.ts` 생성
  - [x] End-to-end 노트 목록 조회 플로우 테스트
  - [x] 페이지네이션 동작 테스트 (10개 이상 노트 생성 후 확인)
  - [x] 사용자 데이터 격리 검증
  - [x] 빈 상태 UI 표시 검증

---

## Dev Notes

### 기술 스택 및 아키텍처 개요
[Source: docs/architecture.md#1-기술-스택]
- **프레임워크:** Next.js (App Router, Server Actions, Server Components)
- **UI:** shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스:** Supabase Postgres
- **ORM:** Drizzle ORM
- **인증:** Supabase Auth

### 이전 스토리에서 완료된 사항

**Story 2.1 - 데이터베이스 스키마 설정:**
[Source: docs/stories/2.1.story.md]
- ✅ notes 테이블 스키마 정의 완료
- ✅ Drizzle ORM 설정 완료 (`lib/db.ts`, `drizzle/schema.ts`)
- ✅ 사용자별 데이터 격리 설계 (user_id 기반)
- ✅ 인덱스 설정: `notes_user_id_idx`, `notes_created_at_idx` (조회 최적화)

**Story 2.2 - 노트 생성:**
[Source: docs/stories/2.2.story.md]
- ✅ createNote Server Action 구현 완료
- ✅ 노트 생성 UI (NoteCreateForm, /notes/new 페이지)
- ✅ 유효성 검사 유틸리티 (`lib/utils/validation.ts`)
- ✅ 헤더에 "+ 새 노트" 버튼 추가 (components/layout/Header.tsx)

### 데이터 모델
[Source: docs/architecture.md#2-데이터-모델, drizzle/schema.ts]

#### Notes 테이블
```typescript
notes {
  id: uuid (PK, auto-generated)
  user_id: uuid (FK, indexed, not null)
  title: varchar(500) (not null)
  content: text (not null)
  created_at: timestamp (not null, default: now())
  updated_at: timestamp (not null, default: now())
}

// 인덱스
- notes_user_id_idx (user_id) → 사용자별 조회 최적화
- notes_created_at_idx (created_at) → 정렬 최적화
```

### Server Actions 명세
[Source: docs/architecture.md#4-서버-액션]

#### getNotes Server Action (신규 구현)
```typescript
// app/actions/notes.ts
export async function getNotes(
  page: number = 1,
  pageSize: number = 10
): Promise<{
  success: boolean
  data?: {
    notes: Array<{
      id: string
      title: string
      content: string
      createdAt: Date
      updatedAt: Date
    }>
    total: number
    page: number
    pageSize: number
    totalPages: number
  }
  error?: string
}>
```

**로직:**
1. Supabase Auth로 현재 사용자 확인 (`getUser()`)
2. 인증 실패 시: `{ success: false, error: "Unauthorized" }`
3. Drizzle ORM으로 노트 조회:
   - WHERE: `user_id = current_user_id`
   - ORDER BY: `created_at DESC`
   - LIMIT: `pageSize`
   - OFFSET: `(page - 1) * pageSize`
4. 전체 노트 개수 조회 (COUNT 쿼리)
5. totalPages 계산: `Math.ceil(total / pageSize)`
6. 성공 시: `{ success: true, data: { notes, total, page, pageSize, totalPages } }`
7. 실패 시: `{ success: false, error: "error message" }`

### 보안 및 권한
[Source: docs/architecture.md#3-보안]

- **인증 확인:**
  - Server Action에서 `getUser()` 호출하여 사용자 확인
  - 미인증 사용자는 노트 목록 조회 불가
  
- **데이터 격리:**
  - notes 쿼리에 `WHERE user_id = current_user_id` 필수
  - 다른 사용자의 노트는 절대 조회 불가
  
- **SQL Injection 방지:**
  - Drizzle ORM의 파라미터화된 쿼리 사용
  - 사용자 입력 직접 쿼리에 삽입 금지

### UI/UX 요구사항
[Source: docs/prd.md#4-Target-Users, Epic 2 목표]

- **직관적인 인터페이스:**
  - 단순하고 깔끔한 노트 카드 디자인
  - Apple/Notion 수준의 UX
  - 미니멀한 레이아웃
  
- **반응형 디자인:**
  - 모바일: 1열 리스트
  - 태블릿: 2열 그리드
  - 데스크톱: 3열 그리드
  - 카드 간격 및 패딩 일관성
  
- **성능 최적화:**
  - Server Components로 초기 렌더링 SSR
  - 페이지네이션으로 대량 데이터 처리
  - 목록 로딩 시간 2초 이내 (Epic 2 성공 지표)

### 페이지네이션 전략

**구현 방식:**
- LIMIT/OFFSET 기반 페이지네이션
- 페이지 크기: 10개 (성능 테스트 후 조정 가능)
- URL 쿼리 파라미터로 페이지 상태 관리 (`?page=1`)
- 브라우저 뒤로가기 지원

**사용자 경험:**
- 현재 페이지/전체 페이지 표시 ("1 / 5")
- 이전/다음 버튼으로 탐색
- 첫 페이지에서 "이전" 버튼 비활성화
- 마지막 페이지에서 "다음" 버튼 비활성화

### 예상 파일 구조
```
app/
  actions/
    notes.ts              # (수정) getNotes Server Action 추가
  page.tsx                # (수정) 노트 목록 페이지 (또는 notes/page.tsx)
  loading.tsx             # (신규) 로딩 UI
components/
  notes/
    NoteList.tsx          # (신규) 노트 목록 컴포넌트
    NoteCard.tsx          # (신규) 개별 노트 카드 컴포넌트
    NotePagination.tsx    # (신규) 페이지네이션 컴포넌트
    EmptyState.tsx        # (신규) 빈 상태 UI 컴포넌트
lib/
  utils/
    dateFormat.ts         # (신규) 날짜 포맷팅 유틸리티
__tests__/
  unit/
    actions/
      notes.test.ts       # (수정) getNotes 테스트 추가
    notes/
      NoteList.test.tsx   # (신규) 노트 목록 컴포넌트 테스트
      NoteCard.test.tsx   # (신규) 노트 카드 컴포넌트 테스트
  integration/
    notes/
      list-notes.test.ts  # (신규) 통합 테스트
```

### 에러 처리
[Source: docs/stories/1.7.story.md - 에러 핸들링 패턴]

- **서버 측:**
  - DB 오류: "노트 목록을 불러올 수 없습니다. 다시 시도해주세요."
  - 인증 오류: "로그인이 필요합니다." → 로그인 페이지로 리다이렉트
  - 페이지 번호 오류: 첫 페이지로 리다이렉트
  
- **클라이언트 측:**
  - 로딩 실패: 에러 UI + 재시도 버튼
  - 빈 목록: 빈 상태 UI 표시

### 기존 컴포넌트 및 유틸리티 활용
[Source: Story 1.1-2.2 Implementation]

- **Supabase Auth:**
  - `lib/supabase/server.ts` - Server Component/Action에서 사용
  - `lib/supabase/client.ts` - Client Component에서 사용
  
- **UI 컴포넌트:**
  - `components/ui/button.tsx` - shadcn/ui Button
  - `components/ui/card.tsx` - shadcn/ui Card (노트 카드 베이스)
  
- **레이아웃:**
  - `components/layout/Header.tsx` - 헤더에 "+ 새 노트" 버튼 존재
  - `app/layout.tsx` - 전체 레이아웃 구조

### 날짜 표시 형식

**상대 시간 (최근 7일):**
- 방금 전
- 5분 전
- 2시간 전
- 3일 전

**절대 시간 (7일 이후):**
- 2025-10-14
- 2025-09-20

**구현 방법:**
- `lib/utils/dateFormat.ts`에 유틸리티 함수 작성
- 또는 `date-fns` 라이브러리 활용 (추가 의존성 필요 시 사용자 확인)

### 성능 고려사항
[Source: docs/architecture.md#6-배포/운영, Epic 2 성공 지표]

- **성능 목표:**
  - 노트 로딩 시간 2초 이내
  - 페이지네이션으로 대량 데이터 처리
  - 인덱스 활용으로 쿼리 최적화
  
- **최적화 전략:**
  - Server Components로 초기 SSR (빠른 First Paint)
  - 인덱스 활용: `notes_user_id_idx`, `notes_created_at_idx`
  - LIMIT/OFFSET으로 필요한 데이터만 조회
  - 본문 미리보기는 첫 100자만 (클라이언트 측 truncate)

### Testing

#### 테스트 파일 위치
- 단위 테스트: `__tests__/unit/actions/notes.test.ts`, `__tests__/unit/notes/NoteList.test.tsx`
- 통합 테스트: `__tests__/integration/notes/list-notes.test.ts`

#### 테스트 프레임워크
[Source: Story 1.1, 1.2 Implementation]
- Jest + React Testing Library
- 테스트 실행: `pnpm test`
- 기존 테스트 설정 활용: `jest.config.mjs`, `jest.setup.mjs`

#### 테스트 요구사항

**단위 테스트:**
- Server Action (getNotes):
  - 정상적인 노트 목록 조회 (기본 페이지: 1)
  - 페이지네이션 동작 (page=2, page=3 등)
  - 페이지 크기 확인 (최대 10개)
  - 최신순 정렬 검증 (created_at DESC)
  - 사용자 스코프 검증 (다른 사용자 노트 제외)
  - 빈 목록 처리 (total=0, notes=[])
  - 미인증 사용자 에러
  - DB 에러 처리
  
- 컴포넌트 (NoteList):
  - 노트 목록 렌더링 (제목, 본문 미리보기, 날짜)
  - 빈 상태 UI 렌더링
  - 노트 카드 클릭 이벤트
  - 반응형 그리드 레이아웃
  
- 컴포넌트 (NotePagination):
  - 이전/다음 버튼 렌더링
  - 페이지 번호 표시
  - 첫/마지막 페이지에서 버튼 비활성화
  - 페이지 변경 이벤트

**통합 테스트:**
- End-to-end 노트 목록 조회 플로우:
  - 사용자 로그인 → 노트 목록 페이지 접근 → 노트 목록 조회
  - 노트 10개 이상 생성 후 페이지네이션 동작 확인
  - "다음" 버튼 클릭 → 2페이지 조회
  - 사용자 데이터 격리 검증 (User A의 노트는 User B에게 보이지 않음)
  - 빈 상태 UI 표시 확인 (노트 없는 신규 사용자)

#### 테스트 커버리지 목표
- Server Action: 100% 커버리지
- 컴포넌트: 80% 이상 커버리지
- 모든 에러 시나리오 테스트

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | Bob (SM Agent) |
| 2025-10-14 | 2.0 | 스토리 구현 완료 - 모든 AC 충족 | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor IDE)

### Debug Log References

없음 - 모든 작업이 원활히 완료됨

### Completion Notes List

- ✅ **getNotes Server Action 구현 완료**
  - 사용자 인증 확인 (Supabase Auth)
  - Drizzle ORM으로 페이지네이션 쿼리 (LIMIT/OFFSET)
  - 최신순 정렬 (created_at DESC)
  - 전체 개수 조회 및 totalPages 계산
  - 페이지 번호/크기 유효성 검사
  - 에러 핸들링 (인증, DB 에러)

- ✅ **UI 컴포넌트 구현 완료**
  - NoteCard: 제목, 본문 미리보기(100자), 날짜 표시, hover 효과
  - EmptyState: 빈 상태 UI + "새 노트 작성" 버튼
  - NoteList: 반응형 그리드 (모바일 1열, 태블릿 2열, 데스크톱 3열)
  - NotePagination: 이전/다음 버튼, 페이지 정보, URL 쿼리 파라미터 관리

- ✅ **페이지 구현 완료**
  - app/page.tsx: Server Component로 SSR 구현
  - URL 쿼리 파라미터에서 페이지 번호 읽기
  - getNotes 호출 및 NoteList/NotePagination 통합
  - 에러 상태 UI 표시

- ✅ **로딩 상태 UI 구현**
  - app/loading.tsx: 스켈레톤 UI (3x3 그리드)
  - 노트 카드 스켈레톤 (제목/본문/날짜 영역)

- ✅ **날짜 포맷팅 유틸리티 구현**
  - 상대 시간 표시 (방금 전, N분 전, N시간 전, N일 전)
  - 절대 시간 표시 (7일 이후, YYYY-MM-DD)
  - truncateText 함수 (말줄임 처리)

- ✅ **테스트 작성 및 검증**
  - Server Action 단위 테스트: 16개 (인증, 페이지네이션, 정렬, 빈 목록 등)
  - NoteList 컴포넌트 테스트: 7개 (렌더링, 빈 상태 UI, 접근성)
  - NotePagination 컴포넌트 테스트: 12개 (버튼 상태, 페이지 변경, 쿼리 파라미터)
  - 날짜 유틸리티 테스트: 10개 (상대/절대 시간, truncate)
  - 통합 테스트: 6개 (E2E 플로우, 페이지네이션, 데이터 격리)
  - **총 51개 테스트 모두 통과!**

- ✅ **접근성 및 UX**
  - ARIA labels 적용 (role="list", role="article" 등)
  - 키보드 네비게이션 지원
  - 반응형 디자인 (Tailwind 그리드)
  - hover 효과 (그림자, 스케일)

### File List

**생성된 파일:**
- `lib/utils/dateFormat.ts` - 날짜 포맷팅 유틸리티
- `components/notes/NoteCard.tsx` - 개별 노트 카드 컴포넌트
- `components/notes/EmptyState.tsx` - 빈 상태 UI 컴포넌트
- `components/notes/NoteList.tsx` - 노트 목록 컴포넌트
- `components/notes/NotePagination.tsx` - 페이지네이션 컴포넌트
- `app/loading.tsx` - 로딩 스켈레톤 UI
- `__tests__/unit/utils/dateFormat.test.ts` - 날짜 유틸리티 테스트 (10개)
- `__tests__/unit/notes/NoteList.test.tsx` - NoteList 컴포넌트 테스트 (7개)
- `__tests__/unit/notes/NotePagination.test.tsx` - NotePagination 컴포넌트 테스트 (12개)
- `__tests__/integration/notes/list-notes.test.ts` - 통합 테스트 (6개)

**수정된 파일:**
- `app/actions/notes.ts` - getNotes Server Action 추가
- `app/page.tsx` - 노트 목록 조회 및 표시 로직 추가
- `__tests__/unit/actions/notes.test.ts` - getNotes 테스트 추가 (16개 총)
- `docs/stories/2.3.story.md` - 상태 업데이트 및 완료 노트 추가

---

## QA Results

_(QA 검토 시 작성)_

