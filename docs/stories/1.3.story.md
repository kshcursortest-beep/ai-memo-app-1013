# Story 1.3: 비밀번호 재설정

## Status

**Ready for Review**

---

## Story

**As a** 등록된 사용자,  
**I want** 비밀번호를 잊어버렸을 때 재설정할 수 있는 기능,  
**so that** 비밀번호를 기억하지 못해도 계정에 다시 접근할 수 있습니다.

---

## Acceptance Criteria

1. 사용자는 로그인 페이지에서 "비밀번호를 잊으셨나요?" 링크를 통해 재설정 페이지로 이동할 수 있어야 한다
2. 비밀번호 재설정 요청 시 등록된 이메일로 재설정 링크가 발송되어야 한다
3. 이메일 내 재설정 링크 클릭 시 새 비밀번호 설정 페이지로 이동해야 한다
4. 새 비밀번호는 최소 8자 이상이어야 하며, 비밀번호 확인 입력이 일치해야 한다
5. 재설정 링크는 1시간 후 만료되어야 한다
6. 비밀번호 재설정 완료 시 자동으로 로그인되고 메인 페이지로 이동해야 한다
7. 등록되지 않은 이메일로 재설정 요청 시에도 보안을 위해 동일한 성공 메시지를 표시해야 한다

---

## Tasks / Subtasks

- [x] Task 1: 비밀번호 재설정 요청 Server Action 구현 (AC: 2, 7)
  - [x] `app/actions/auth.ts`에 `requestPasswordReset` 함수 추가
  - [x] Supabase Auth의 `resetPasswordForEmail` 메서드 호출
  - [x] 재설정 이메일 발송 처리
  - [x] 에러 응답 표준화 (보안을 위해 이메일 존재 여부 노출 금지)

- [x] Task 2: 비밀번호 재설정 요청 UI 구현 (AC: 1, 2)
  - [x] `components/auth/ForgotPasswordForm.tsx` 생성
  - [x] 이메일 입력 필드
  - [x] 재설정 요청 버튼
  - [x] Tailwind CSS로 반응형 레이아웃 스타일링
  - [x] 접근성 속성 추가

- [x] Task 3: 비밀번호 재설정 요청 페이지 생성 (AC: 1)
  - [x] `app/forgot-password/page.tsx` 생성
  - [x] ForgotPasswordForm 컴포넌트 통합
  - [x] 성공 시 안내 메시지 표시
  - [x] 로그인 페이지로 돌아가기 링크

- [x] Task 4: 로그인 페이지에 링크 추가 (AC: 1)
  - [x] `components/auth/SignInForm.tsx`에 "비밀번호를 잊으셨나요?" 링크 추가
  - [x] `/forgot-password` 경로로 연결

- [x] Task 5: 새 비밀번호 설정 Server Action 구현 (AC: 4, 5, 6)
  - [x] `app/actions/auth.ts`에 `updatePassword` 함수 추가
  - [x] Supabase Auth의 `updateUser` 메서드로 비밀번호 업데이트
  - [x] 토큰 유효성 검증
  - [x] 비밀번호 강도 검증

- [x] Task 6: 새 비밀번호 설정 UI 구현 (AC: 4)
  - [x] `components/auth/ResetPasswordForm.tsx` 생성
  - [x] 새 비밀번호 입력 필드
  - [x] 비밀번호 확인 입력 필드
  - [x] 비밀번호 강도 표시기 (기존 컴포넌트 재사용)
  - [x] 일치 여부 검증 및 피드백

- [x] Task 7: 새 비밀번호 설정 페이지 생성 (AC: 3, 6)
  - [x] `app/reset-password/page.tsx` 생성
  - [x] URL에서 토큰 추출 및 검증
  - [x] ResetPasswordForm 컴포넌트 통합
  - [x] 성공 시 메인 페이지 리다이렉션

- [x] Task 8: 에러 핸들링 및 사용자 피드백
  - [x] Toast 알림 통합 (기존 Sonner 활용)
  - [x] 만료된 토큰 에러 처리
  - [x] 네트워크 에러 처리

- [x] Task 9: 단위 테스트 작성
  - [x] 비밀번호 재설정 요청 Server Action 테스트
  - [x] 비밀번호 업데이트 Server Action 테스트
  - [x] ForgotPasswordForm 컴포넌트 테스트
  - [x] ResetPasswordForm 컴포넌트 테스트

- [x] Task 10: 통합 테스트 작성
  - [x] 비밀번호 재설정 전체 플로우 테스트
  - [x] 만료된 토큰 시나리오 테스트
  - [x] 비밀번호 불일치 시나리오 테스트

---

## Dev Notes

### 기술 스택 및 아키텍처 개요
[Source: docs/architecture.md#1-기술-스택]
- **프레임워크:** Next.js (App Router 사용)
- **UI 라이브러리:** shadcn/ui + Tailwind CSS + Radix UI
- **DB/인증:** Supabase (Auth 기능 활용)
- **호스팅:** Vercel

### 인증 구현 세부사항
[Source: docs/architecture.md#3-보안]
- 사용자 인증은 Supabase Auth API 사용
- 비밀번호 재설정은 Supabase의 이메일 기반 재설정 플로우 활용
- 재설정 링크는 Supabase가 자동으로 만료 처리

### 기존 구현 참고사항
[Source: docs/stories/1.1.story.md, 1.2.story.md - Previous Story Insights]
- Supabase 클라이언트 초기화 완료: `lib/supabase/client.ts`, `lib/supabase/server.ts`
- 인증 Server Actions 위치: `app/actions/auth.ts`
- UI 컴포넌트 위치: `components/auth/`
- 유효성 검사 유틸: `lib/utils/validation.ts`
- 비밀번호 강도 표시기: `components/auth/PasswordStrength.tsx` (재사용 가능)
- Toast 알림: Sonner 사용 (app/layout.tsx에 이미 통합)
- 테스트 프레임워크: Jest + React Testing Library

### Supabase 비밀번호 재설정 플로우
1. **재설정 요청**: `auth.resetPasswordForEmail()` 호출
   - Supabase가 사용자 이메일로 재설정 링크 발송
   - 링크 형식: `{SITE_URL}/reset-password?access_token={token}&type=recovery`
2. **토큰 검증**: URL에서 access_token 추출
   - Supabase 클라이언트가 자동으로 세션 복구
3. **비밀번호 업데이트**: `auth.updateUser({ password: newPassword })` 호출

### 프로젝트 구조
예상 파일 구조 (Story 1.1, 1.2 기반):
```
app/
  forgot-password/
    page.tsx              # 비밀번호 재설정 요청 페이지
  reset-password/
    page.tsx              # 새 비밀번호 설정 페이지
  actions/
    auth.ts               # requestPasswordReset, updatePassword 추가
components/
  auth/
    ForgotPasswordForm.tsx  # 재설정 요청 폼
    ResetPasswordForm.tsx   # 새 비밀번호 설정 폼
    PasswordStrength.tsx    # (기존) 비밀번호 강도 표시기
    SignInForm.tsx          # (수정) 비밀번호 찾기 링크 추가
```

### UI/UX 요구사항
[Source: docs/prd.md#4-Target-Users]
- 모바일 우선 사용자 고려 → 반응형 디자인 필수
- Apple/Notion 수준의 직관적인 UX 지향
- 단순하고 깔끔하며 미니멀한 UI

### 보안 고려사항
[Source: AC 7]
- 등록되지 않은 이메일로 재설정 요청 시에도 동일한 성공 메시지 표시
- 이메일 존재 여부를 노출하지 않아 보안 강화
- 재설정 링크는 1회용 (사용 후 무효화)
- 토큰 만료 시간: 1시간 (Supabase 기본값)

### 성공 지표
[Source: docs/epics/epic-1-user-authentication.md#성공-지표]
- 인증 관련 에러율 1% 미만

### Testing

#### 테스트 파일 위치
- 단위 테스트: `__tests__/unit/auth/` 디렉토리
- 통합 테스트: `__tests__/integration/auth/` 디렉토리

#### 테스트 프레임워크
[Source: Story 1.1, 1.2 Implementation]
- Jest + React Testing Library
- 테스트 실행: `pnpm test`
- 기존 테스트 설정 활용: `jest.config.mjs`, `jest.setup.mjs`

#### 테스트 요구사항
- 비밀번호 재설정 요청 Server Action 테스트
- 비밀번호 업데이트 Server Action 테스트
- 폼 컴포넌트 렌더링 및 유효성 검사 테스트
- 전체 비밀번호 재설정 플로우 통합 테스트
- 만료된 토큰, 비밀번호 불일치 등 에러 시나리오 테스트

#### 테스트 커버리지 목표
- 핵심 비즈니스 로직 100% 커버리지
- UI 컴포넌트 주요 인터랙션 테스트

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

없음

### Completion Notes List

- 비밀번호 재설정 플로우 구현 완료 (Supabase Auth 기반)
- ForgotPasswordForm과 ResetPasswordForm 컴포넌트 생성
- 보안을 위해 이메일 존재 여부와 관계없이 동일한 성공 메시지 반환
- 비밀번호 강도 표시기 재사용으로 일관된 UX 제공
- .env.local에 NEXT_PUBLIC_SITE_URL 추가
- 모든 테스트 통과 (62개 → 66개)

### File List

**신규 파일:**
- `components/auth/ForgotPasswordForm.tsx`
- `components/auth/ResetPasswordForm.tsx`
- `app/forgot-password/page.tsx`
- `app/reset-password/page.tsx`
- `__tests__/unit/auth/ForgotPasswordForm.test.tsx`
- `__tests__/unit/auth/ResetPasswordForm.test.tsx`
- `__tests__/integration/auth/password-reset.test.ts`

**수정된 파일:**
- `app/actions/auth.ts` (requestPasswordReset, updatePassword 함수 추가)
- `components/auth/SignInForm.tsx` (비밀번호 찾기 링크 추가)
- `.env.local` (NEXT_PUBLIC_SITE_URL 추가)

---

## QA Results

_(QA 검토 시 작성)_


