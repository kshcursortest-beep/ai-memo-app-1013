# Story 2.1: 노트 관리 데이터베이스 스키마 설정

## Status

**Done**

---

## Story

**As a** 시스템 개발자,  
**I want** 노트 관리를 위한 데이터베이스 스키마를 Drizzle ORM으로 정의하고 마이그레이션을 적용,  
**so that** 노트 CRUD 기능을 안정적으로 구현할 수 있는 데이터 구조를 갖출 수 있습니다.

---

## Acceptance Criteria

1. `notes` 테이블이 정의되어야 하며, 필수 컬럼(id, user_id, title, content, created_at, updated_at)을 포함해야 한다
2. `note_tags` 테이블이 정의되어야 하며, note_id와 tag 관계를 관리해야 한다
3. `summaries` 테이블이 정의되어야 하며, AI 요약 결과를 저장할 수 있어야 한다
4. 모든 테이블은 적절한 인덱스와 외래 키 제약조건을 가져야 한다
5. 사용자별 데이터 격리를 위한 user_id 기반 권한 스코프가 명확해야 한다
6. Drizzle Kit을 사용하여 마이그레이션 파일이 생성되어야 한다
7. 마이그레이션이 Supabase Postgres에 성공적으로 적용되어야 한다
8. 스키마 타입이 TypeScript로 자동 생성되어야 한다

---

## Tasks / Subtasks

- [x] Task 1: Notes 테이블 스키마 정의 (AC: 1, 4, 5)
  - [x] `drizzle/schema.ts`에 `notes` 테이블 추가
  - [x] 컬럼 정의:
    - [x] `id` (uuid, primary key, defaultRandom)
    - [x] `userId` (uuid, not null, 외래 키)
    - [x] `title` (varchar(500), not null)
    - [x] `content` (text, not null)
    - [x] `createdAt` (timestamp, not null, defaultNow)
    - [x] `updatedAt` (timestamp, not null, defaultNow with $onUpdate)
  - [x] `userId` 컬럼에 인덱스 추가 (쿼리 성능 최적화)
  - [x] `createdAt` 컬럼에 인덱스 추가 (정렬 성능)

- [x] Task 2: Note Tags 테이블 스키마 정의 (AC: 2, 4, 5)
  - [x] `drizzle/schema.ts`에 `noteTags` 테이블 추가
  - [x] 컬럼 정의:
    - [x] `id` (uuid, primary key, defaultRandom)
    - [x] `noteId` (uuid, not null, 외래 키 → notes.id)
    - [x] `tag` (varchar(50), not null)
    - [x] `createdAt` (timestamp, not null, defaultNow)
  - [x] 복합 인덱스: (noteId, tag) - 중복 방지 및 검색 최적화
  - [x] `noteId` 외래 키에 CASCADE DELETE 설정

- [x] Task 3: Summaries 테이블 스키마 정의 (AC: 3, 4, 5)
  - [x] `drizzle/schema.ts`에 `summaries` 테이블 추가
  - [x] 컬럼 정의:
    - [x] `id` (uuid, primary key, defaultRandom)
    - [x] `noteId` (uuid, not null, unique, 외래 키 → notes.id)
    - [x] `model` (varchar(100), not null) - AI 모델명
    - [x] `content` (text, not null) - 요약 내용
    - [x] `createdAt` (timestamp, not null, defaultNow)
  - [x] `noteId`에 UNIQUE 제약조건 (노트당 1개의 요약만 허용)
  - [x] `noteId` 외래 키에 CASCADE DELETE 설정

- [x] Task 4: 테이블 관계 정의 (AC: 4)
  - [x] Drizzle Relations 설정:
    - [x] notes ↔ noteTags (one-to-many)
    - [x] notes ↔ summaries (one-to-one)
  - [x] 관계 쿼리 테스트를 위한 예제 작성 (주석으로 포함)

- [x] Task 5: 마이그레이션 생성 및 적용 (AC: 6, 7)
  - [x] `pnpm drizzle-kit generate` 실행 → 마이그레이션 파일 생성
  - [x] 생성된 마이그레이션 SQL 파일 검토
  - [x] Supabase MCP로 마이그레이션 적용 → Supabase Postgres에 스키마 반영
  - [x] Supabase MCP로 테이블 생성 확인
  - [x] Supabase List Tables API로 테이블 및 인덱스 확인

- [x] Task 6: TypeScript 타입 검증 (AC: 8)
  - [x] 스키마에서 자동 생성된 타입 확인
  - [x] 예제 쿼리 작성하여 타입 안정성 검증:
    - [x] `db.select().from(notes)`
    - [x] `db.insert(notes).values(...)`
    - [x] 관계 쿼리 예제
  - [x] TypeScript 컴파일 에러 없음 확인

- [x] Task 7: 스키마 문서화 (AC: 1, 2, 3)
  - [x] 각 테이블 및 컬럼에 JSDoc 주석 추가
  - [x] 외래 키 관계 명시
  - [x] 인덱스 목적 설명
  - [x] 사용자 스코프 권한 정책 주석

- [x] Task 8: 단위 테스트 작성
  - [x] `__tests__/unit/drizzle/schema.test.ts` 생성
  - [x] 스키마 정의 검증 (테이블명, 컬럼명, 타입)
  - [x] 관계 정의 검증
  - [x] 기본값 및 제약조건 검증

- [x] Task 9: 통합 테스트 작성
  - [x] `__tests__/integration/db/notes-schema.test.ts` 생성
  - [x] 노트 생성 및 조회 테스트 (Supabase MCP로 검증)
  - [x] 태그 추가 및 조회 테스트 (Supabase MCP로 검증)
  - [x] 요약 생성 및 조회 테스트 (Supabase MCP로 검증)
  - [x] CASCADE DELETE 동작 검증 (노트 삭제 시 태그/요약도 삭제) (Supabase MCP로 검증)
  - [x] 사용자별 데이터 격리 검증 (테스트 코드 작성 완료)

---

## Dev Notes

### 기술 스택 및 아키텍처 개요
[Source: docs/architecture.md#1-기술-스택]
- **데이터베이스:** Supabase Postgres
- **ORM:** Drizzle ORM (마이그레이션/쿼리)
- **프레임워크:** Next.js (App Router)
- **호스팅:** Vercel

### 기존 구현 참고사항
[Source: drizzle/schema.ts, drizzle.config.ts, lib/db.ts]
- Drizzle 환경 이미 설정 완료:
  - `drizzle.config.ts`: Drizzle Kit 설정 (schema 경로, 마이그레이션 경로)
  - `lib/db.ts`: Drizzle 클라이언트 초기화 (postgres-js 사용)
  - `drizzle/schema.ts`: 기존 `userProfiles` 테이블 정의됨
- 마이그레이션 경로: `drizzle/migrations/`
- DATABASE_URL 환경변수 사용 (.env.local)

### 데이터 모델 명세
[Source: docs/architecture.md#2-데이터-모델]

#### 1. Notes 테이블
```typescript
notes {
  id: uuid (PK)
  user_id: uuid (FK, indexed)
  title: varchar(500)
  content: text
  created_at: timestamp (indexed)
  updated_at: timestamp
}
```

#### 2. Note Tags 테이블
```typescript
note_tags {
  id: uuid (PK)
  note_id: uuid (FK → notes.id, CASCADE DELETE)
  tag: varchar(50)
  created_at: timestamp
  // Composite index: (note_id, tag)
}
```

#### 3. Summaries 테이블
```typescript
summaries {
  id: uuid (PK)
  note_id: uuid (FK → notes.id, UNIQUE, CASCADE DELETE)
  model: varchar(100)  // 예: "gemini-1.5-flash"
  content: text
  created_at: timestamp
}
```

### 권한 스코프 및 보안
[Source: docs/architecture.md#3-보안]
- **사용자별 데이터 격리:**
  - Notes/Tags: `user_id` 스코프로 소유자만 CRUD 가능
  - Summaries: `note_id`를 통해 간접적으로 사용자 스코프 적용
- **권한 제어:**
  - 모든 Drizzle 쿼리는 서버 코드에서 사용자 스코프를 WHERE 절로 명시적 강제
  - RLS는 사용하지 않고 애플리케이션 레벨에서 권한 관리
- **키 관리:**
  - Supabase 서비스 롤 키는 서버 전용 (클라이언트 노출 금지)

### Drizzle ORM 사용 패턴

#### 스키마 정의 예제
```typescript
import { pgTable, uuid, varchar, text, timestamp, index } from 'drizzle-orm/pg-core'
import { relations } from 'drizzle-orm'

export const notes = pgTable('notes', {
  id: uuid('id').defaultRandom().primaryKey(),
  userId: uuid('user_id').notNull(),
  title: varchar('title', { length: 500 }).notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow().$onUpdate(() => new Date()),
}, (table) => ({
  userIdIdx: index('notes_user_id_idx').on(table.userId),
  createdAtIdx: index('notes_created_at_idx').on(table.createdAt),
}))

export const notesRelations = relations(notes, ({ many, one }) => ({
  tags: many(noteTags),
  summary: one(summaries),
}))
```

#### 관계 정의 (Relations)
- Drizzle의 `relations` API 사용
- One-to-many: notes → noteTags
- One-to-one: notes → summaries

#### 마이그레이션 워크플로우
1. 스키마 수정: `drizzle/schema.ts`
2. 마이그레이션 생성: `pnpm drizzle-kit generate`
3. SQL 검토: `drizzle/migrations/*.sql`
4. 스키마 적용: `pnpm drizzle-kit push`
5. 확인: `pnpm drizzle-kit studio` 또는 Supabase Dashboard

### 예상 파일 구조
```
drizzle/
  schema.ts              # (수정) notes, noteTags, summaries 테이블 추가
  migrations/
    0001_xxx.sql         # (자동 생성) 마이그레이션 SQL
lib/
  db.ts                  # (변경 없음) Drizzle 클라이언트
drizzle.config.ts        # (변경 없음) Drizzle Kit 설정
__tests__/
  unit/
    drizzle/
      schema.test.ts     # (신규) 스키마 정의 단위 테스트
  integration/
    db/
      notes-schema.test.ts  # (신규) DB 통합 테스트
```

### 인덱스 전략
[Source: docs/architecture.md#5-검색-전략]
- `notes.user_id`: 사용자별 노트 조회 성능 최적화
- `notes.created_at`: 최신순 정렬 성능 최적화
- `note_tags(note_id, tag)`: 복합 인덱스로 태그 검색 및 중복 방지
- 향후 Full Text Search를 위해 GIN 인덱스 추가 가능 (Epic 5에서 구현)

### 제약조건 및 참조 무결성
- **Foreign Keys:**
  - `noteTags.noteId` → `notes.id` (CASCADE DELETE)
  - `summaries.noteId` → `notes.id` (CASCADE DELETE)
- **Unique Constraints:**
  - `summaries.noteId` (노트당 1개의 요약만 허용)
- **Not Null:**
  - 모든 필수 컬럼은 NOT NULL 제약

### Testing

#### 테스트 파일 위치
- 단위 테스트: `__tests__/unit/drizzle/schema.test.ts`
- 통합 테스트: `__tests__/integration/db/notes-schema.test.ts`

#### 테스트 프레임워크
[Source: Story 1.1, 1.2 Implementation]
- Jest + React Testing Library
- 테스트 실행: `pnpm test`
- 기존 테스트 설정 활용: `jest.config.mjs`, `jest.setup.mjs`

#### 테스트 요구사항
- **단위 테스트:**
  - 스키마 정의 검증 (테이블명, 컬럼명, 타입)
  - 관계 정의 검증
  - 기본값 및 제약조건 검증
- **통합 테스트:**
  - 노트 CRUD 작업 (생성, 조회, 수정, 삭제)
  - 태그 추가 및 조회
  - 요약 생성 및 조회
  - CASCADE DELETE 동작 검증
  - 사용자별 데이터 격리 검증
  - 동시성 테스트 (여러 사용자 동시 작업)

#### 테스트 커버리지 목표
- 스키마 정의 100% 커버리지
- 모든 CRUD 작업 테스트
- 외래 키 제약조건 동작 검증

#### 테스트 환경 설정
- 테스트용 DATABASE_URL 사용 (.env.test)
- 테스트 전 스키마 초기화
- 테스트 후 데이터 정리

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | Bob (SM Agent) |
| 2025-10-14 | 2.0 | 스토리 구현 완료 - 모든 AC 충족 | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor IDE)

### Debug Log References

없음 - 모든 작업이 원활히 완료됨

### Completion Notes List

- ✅ 3개 테이블 스키마 정의 완료 (notes, note_tags, summaries)
- ✅ Drizzle Relations API를 사용한 관계 정의 완료 (one-to-many, one-to-one)
- ✅ 외래 키 CASCADE DELETE 설정 완료 및 검증
- ✅ 인덱스 전략 구현 (user_id, created_at, 복합 인덱스)
- ✅ UNIQUE 제약조건 구현 (summaries.noteId)
- ✅ 마이그레이션 파일 생성 및 Supabase에 적용 (Supabase MCP 활용)
- ✅ TypeScript 타입 안정성 검증 (예제 파일 작성)
- ✅ 단위 테스트 17/17 통과
- ✅ 통합 테스트 작성 및 Supabase MCP로 CRUD/CASCADE DELETE 검증 완료
- ⚠️ 참고: 로컬 통합 테스트는 DATABASE_URL 설정 후 실행 가능 (현재 환경변수에 비밀번호 플레이스홀더 남아있음)

### File List

**생성된 파일:**
- `drizzle/migrations/0000_cynical_oracle.sql` - 마이그레이션 SQL (3개 테이블 + 인덱스 + 외래 키)
- `__tests__/unit/drizzle/schema.test.ts` - 단위 테스트 (17개 테스트, 모두 통과)
- `__tests__/integration/db/notes-schema.test.ts` - 통합 테스트 (15개 테스트)

**수정된 파일:**
- `drizzle/schema.ts` - notes, noteTags, summaries 테이블 및 관계 추가
- `docs/stories/2.1.story.md` - 상태 업데이트 및 완료 노트 추가

---

## QA Results

_(QA 검토 시 작성)_

